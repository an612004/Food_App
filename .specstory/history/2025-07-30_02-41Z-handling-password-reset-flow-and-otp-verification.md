<!-- Generated by SpecStory -->

# Handling password reset flow and OTP verification (2025-07-30 02:41Z)

_**User**_

khi nhấn phần quên mật khẩu nhấn xác nhận sẽ chuyển trang nhập mã otp và đổi mật khẩu

---

_**Assistant**_

Bạn đã làm đúng luồng chuyển bước khi quên mật khẩu bằng biến `_forgotStep`. Tuy nhiên, API backend của bạn dùng endpoint `/api/v1/auth/verify` để xác thực mã OTP (không phải `/verify-reset-code`).  
Bạn nên sửa lại endpoint khi xác thực mã OTP ở hàm `_verifyCode` như sau:

````dart
// ...existing code...
final response = await http.post(
  Uri.parse('https://food-app-cweu.onrender.com/api/v1/auth/verify'), // Sửa endpoint
  headers: {'Content-Type': 'application/json'},
  body: jsonEncode({'email': _resetEmail, 'code': code}),
);
// ...existing code...
````

**Tóm tắt luồng:**
1. Nhấn "Quên mật khẩu?" → nhập email → gửi mã OTP (API `/forgot-password`).
2. Nhập mã OTP → xác thực (API `/verify`).
3. Nếu đúng, chuyển sang nhập mật khẩu mới → gửi API `/reset-password`.

Bạn đã xử lý đúng việc chuyển bước bằng `_forgotStep = 1` và `_forgotStep = 2`.  
Chỉ cần sửa lại endpoint xác thực mã OTP như trên là sẽ đúng với backend.

---

_**User**_

[{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "undefined_identifier",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/undefined_identifier",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 8,
	"message": "Undefined name 'code'.\nTry correcting the name to one that is defined, or defining the name.",
	"source": "dart",
	"startLineNumber": 43,
	"startColumn": 51,
	"endLineNumber": 43,
	"endColumn": 55,
	"origin": "extHost1"
}]

---

_**Assistant**_

Bạn đang bị lỗi `Undefined name 'code'` trong hàm `_sendForgotPasswordEmail`.  
Nguyên nhân: Bạn đang gửi mã xác thực (`code`) trong API gửi email quên mật khẩu, nhưng thực tế API `/forgot-password` chỉ cần email, không cần `code`.

**Cách sửa:**  
Thay đoạn gửi request trong `_sendForgotPasswordEmail` thành chỉ gửi email, không gửi code.

````dart
// ...existing code...
final response = await http.post(
  Uri.parse('https://food-app-cweu.onrender.com/api/v1/auth/forgot-password'),
  headers: {'Content-Type': 'application/json'},
  body: jsonEncode({'email': email}),
);
// ...existing code...
````

**Tóm lại:**  
- `_sendForgotPasswordEmail`: chỉ gửi email lên endpoint `/forgot-password`.
- Xác thực mã OTP ở `_verifyCode` mới gửi code.

Hãy thay thế đoạn code gửi request trong `_sendForgotPasswordEmail` như trên để hết lỗi.

---

_**User**_

khi nhấn gửi mã xác nhận sẽ chuyển trang nhập mã

---

_**Assistant**_

Bạn đã làm đúng luồng chuyển trang nhập mã xác nhận. Khi nhấn nút "Gửi mã xác thực", hàm `_sendForgotPasswordEmail` sẽ được gọi. Nếu gửi email thành công (`response.statusCode == 200`), biến `_forgotStep` sẽ được set về `1`:

````dart
if (response.statusCode == 200) {
  setState(() {
    _forgotStep = 1; // Chuyển sang bước nhập mã xác thực
    _resetEmail = email;
  });
  ScaffoldMessenger.of(context).showSnackBar(
    const SnackBar(
      content: Text('Đã gửi email đặt lại mật khẩu! Vui lòng kiểm tra email để lấy mã xác thực.'),
    ),
  );
}
````

Ở phần build UI, khi `_forgotStep == 1`, giao diện sẽ hiển thị form nhập mã xác thực.  
Như vậy, khi nhấn "Gửi mã xác thực", app sẽ tự động chuyển sang trang nhập mã OTP đúng như bạn yêu cầu.  
Bạn không cần sửa gì thêm, luồng này đã đúng!

---

_**User**_

cập nhật import 'package:flutter/material.dart';
import 'package:food_app_flutter/services/auth_service.dart';
import 'register_screen.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import '../pages_user/home_user.dart';
import '../admin/admin_home.dart';
// import '../admin/quan_ly_nguoi_dung.dart';
import '../admin/quan_ly_thong_ke.dart';

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  // Trạng thái hiển thị form reset password trên giao diện
  bool _showForgotPassword = false;
  int _forgotStep = 0; // 0: nhập email, 1: nhập mã, 2: nhập mật khẩu mới
  String _resetEmail = '';
  final TextEditingController _forgotEmailController = TextEditingController();
  final TextEditingController _resetCodeController = TextEditingController();
  final TextEditingController _resetPasswordController =
      TextEditingController();
  final TextEditingController _resetConfirmController = TextEditingController();

  Future<void> _sendForgotPasswordEmail() async {
    final email = _forgotEmailController.text.trim().toLowerCase();
    if (email.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Vui lòng nhập email!')),
      );
      return;
    }
    try {
      // ...existing code...
      final response = await http.post(
        Uri.parse(
            'https://food-app-cweu.onrender.com/api/v1/auth/forgot-password'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'email': email}),
      );
// ...existing code...
      if (response.statusCode == 200) {
        setState(() {
          _forgotStep = 1;
          _resetEmail = email;
        });
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
              content: Text(
                  'Đã gửi email đặt lại mật khẩu! Vui lòng kiểm tra email để lấy mã xác thực.')),
        );
      } else {
        String errorMsg = 'Lỗi: ${response.statusCode}';
        try {
          final err = jsonDecode(response.body);
          if (err is Map && err['message'] != null) {
            errorMsg = err['message'].toString();
          }
        } catch (_) {}
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMsg)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: $e')),
      );
    }
  }

  Future<void> _verifyCode() async {
    final code = _resetCodeController.text.trim();
    if (code.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Vui lòng nhập mã xác thực!')),
      );
      return;
    }
    try {
      final response = await http.post(
        Uri.parse(
            'https://food-app-cweu.onrender.com/api/v1/auth/verify-reset-code'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'email': _resetEmail, 'code': code}),
      );
      if (response.statusCode == 200) {
        setState(() {
          _forgotStep = 2;
        });
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
              content: Text('Mã xác thực đúng. Vui lòng nhập mật khẩu mới!')),
        );
      } else {
        String errorMsg = 'Mã xác thực không đúng!';
        try {
          final err = jsonDecode(response.body);
          if (err is Map && err['message'] != null) {
            errorMsg = err['message'].toString();
          }
        } catch (_) {}
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMsg)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: $e')),
      );
    }
  }

  Future<void> _resetPassword() async {
    final pass = _resetPasswordController.text.trim();
    final confirm = _resetConfirmController.text.trim();
    if (pass.isEmpty || confirm.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Vui lòng nhập đủ thông tin!')),
      );
      return;
    }
    if (pass != confirm) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Mật khẩu nhập lại không khớp!')),
      );
      return;
    }
    try {
      final response = await http.post(
        Uri.parse(
            'https://food-app-cweu.onrender.com/api/v1/auth/reset-password'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({
          'email': _resetEmail,
          'code': _resetCodeController.text.trim(),
          'newPassword': pass,
        }),
      );
      if (response.statusCode == 200) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Đặt lại mật khẩu thành công!')),
        );
        setState(() {
          _showForgotPassword = false;
          _forgotStep = 0;
        });
      } else {
        String errorMsg = 'Lỗi: ${response.statusCode}';
        try {
          final err = jsonDecode(response.body);
          if (err is Map && err['message'] != null) {
            errorMsg = err['message'].toString();
          }
        } catch (_) {}
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMsg)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: $e')),
      );
    }
  }

  Future<void> _showResetPasswordDialog(String email) async {
    final codeController = TextEditingController();
    final passwordController = TextEditingController();
    final confirmController = TextEditingController();
    String? snackMessage;
    await showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => AlertDialog(
        title: const Text('Đặt lại mật khẩu'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: codeController,
              decoration:
                  const InputDecoration(labelText: 'Mã xác thực (code)'),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: passwordController,
              obscureText: true,
              decoration: const InputDecoration(labelText: 'Mật khẩu mới'),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: confirmController,
              obscureText: true,
              decoration:
                  const InputDecoration(labelText: 'Nhập lại mật khẩu mới'),
            ),
          ],
        ),
        actions: [
          TextButton(
            child: const Text('Hủy'),
            onPressed: () => Navigator.pop(context),
          ),
          ElevatedButton(
            style: ElevatedButton.styleFrom(backgroundColor: Colors.orange),
            child: const Text('Đặt lại'),
            onPressed: () async {
              final code = codeController.text.trim();
              final pass = passwordController.text.trim();
              final confirm = confirmController.text.trim();
              if (code.isEmpty || pass.isEmpty || confirm.isEmpty) {
                snackMessage = 'Vui lòng nhập đủ thông tin!';
                Navigator.pop(context);
                return;
              }
              if (pass != confirm) {
                snackMessage = 'Mật khẩu nhập lại không khớp!';
                Navigator.pop(context);
                return;
              }
              try {
                final response = await http.post(
                  Uri.parse(
                      'https://food-app-cweu.onrender.com/api/v1/auth/reset-password'),
                  headers: {'Content-Type': 'application/json'},
                  body: jsonEncode({
                    'email': email,
                    'code': code,
                    'newPassword': pass,
                  }),
                );
                if (response.statusCode == 200) {
                  snackMessage = 'Đặt lại mật khẩu thành công!';
                } else {
                  String errorMsg = 'Lỗi: ${response.statusCode}';
                  try {
                    final err = jsonDecode(response.body);
                    if (err is Map && err['message'] != null) {
                      errorMsg = err['message'].toString();
                    }
                  } catch (_) {}
                  snackMessage = errorMsg;
                }
              } catch (e) {
                snackMessage = 'Lỗi: $e';
              }
              Navigator.pop(context);
            },
          ),
        ],
      ),
    );
    if (snackMessage != null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(snackMessage!)),
      );
    }
  }

  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();
  bool _isLoading = false;
  bool _obscurePassword = true;

  Future<void> _login() async {
    setState(() {
      _isLoading = true;
    });
    final email = _emailController.text.trim();
    final password = _passwordController.text.trim();
    if (email.isEmpty || password.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
            content: Text('Vui lòng nhập đầy đủ email và mật khẩu!')),
      );
      setState(() {
        _isLoading = false;
      });
      return;
    }
    try {
      final response = await http.post(
        Uri.parse('https://food-app-cweu.onrender.com/api/v1/auth/login'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'email': email, 'password': password}),
      );
      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        debugPrint('Login response: ${response.body}');
        // In ra toàn bộ data để kiểm tra cấu trúc
        debugPrint('Login data: $data');
        var user = data['data'];
        // Thử lấy token từ nhiều trường phổ biến
        String? accessToken = '';
        if (data['accessToken'] != null)
          accessToken = data['accessToken'];
        else if (data['token'] != null)
          accessToken = data['token'];
        else if (user?['accessToken'] != null)
          accessToken = user?['accessToken'];
        else if (user?['token'] != null) accessToken = user?['token'];
        debugPrint('AccessToken to save: $accessToken');
        if (accessToken != null && accessToken.toString().isNotEmpty) {
          final prefs = await SharedPreferences.getInstance();
          await prefs.setString('token', accessToken.toString());
        }
        if (user != null) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Đăng nhập thành công!')),
          );
          await Future.delayed(const Duration(milliseconds: 500));
          // Lấy role từ user object, có thể là 'role', 'userRole', hoặc 'type'
          final role =
              user['role'] ?? user['userRole'] ?? user['type'] ?? 'user';
          // ...existing code...
          // ...existing code...
          if (role == 'admin') {
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(
                builder: (context) => AdminHome(
                  userRole: role,
                  userEmail: user['email'] ?? '',
                ),
              ),
            );
          } else {
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(builder: (context) => const HomeUser()),
            );
          }
// ...existing code...
// ...existing code...
        } else {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
                content: Text('Không tìm thấy thông tin người dùng!')),
          );
        }
      } else {
        String errorMessage = 'Đăng nhập thất bại: ${response.statusCode}';
        try {
          final errorData = jsonDecode(response.body);
          if (errorData['message'] != null) {
            errorMessage = errorData['message'].toString();
          } else if (response.statusCode == 401) {
            errorMessage = 'Sai email hoặc mật khẩu.';
          } else if (response.statusCode == 404) {
            errorMessage = 'Tài khoản không tồn tại hoặc chưa đăng ký.';
          }
        } catch (_) {
          // Nếu không parse được JSON thì giữ nguyên errorMessage
        }
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMessage)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: $e')),
      );
    }
    setState(() {
      _isLoading = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: SingleChildScrollView(
        padding: const EdgeInsets.symmetric(horizontal: 25, vertical: 60),
        child: !_showForgotPassword
            ? Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  const SizedBox(height: 20),
                  const Text(
                    'Đăng Nhập KFC FOOD',
                    style: TextStyle(
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                      color: Colors.orange,
                    ),
                  ),
                  const SizedBox(height: 40),
                  // Email Field
                  TextField(
                    controller: _emailController,
                    decoration: InputDecoration(
                      labelText: 'Email',
                      prefixIcon: const Icon(Icons.email, color: Colors.orange),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(30),
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Password Field
                  TextField(
                    controller: _passwordController,
                    obscureText: _obscurePassword,
                    decoration: InputDecoration(
                      labelText: 'Mật Khẩu',
                      prefixIcon: const Icon(Icons.lock, color: Colors.orange),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(30),
                      ),
                      suffixIcon: IconButton(
                        icon: Icon(
                          _obscurePassword
                              ? Icons.visibility_off
                              : Icons.visibility,
                          color: Colors.orange,
                        ),
                        onPressed: () {
                          setState(() {
                            _obscurePassword = !_obscurePassword;
                          });
                        },
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Forgot password
                  Align(
                    alignment: Alignment.centerRight,
                    child: TextButton(
                      onPressed: _isLoading
                          ? null
                          : () {
                              setState(() {
                                _showForgotPassword = true;
                                _forgotStep = 0;
                                _forgotEmailController.clear();
                                _resetCodeController.clear();
                                _resetPasswordController.clear();
                                _resetConfirmController.clear();
                              });
                            },
                      child: const Text(
                        'Quên mật khẩu?',
                        style: TextStyle(color: Colors.orange),
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Login Button
                  SizedBox(
                    width: double.infinity,
                    height: 50,
                    child: ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.orange,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(30),
                        ),
                      ),
                      onPressed: _isLoading ? null : _login,
                      child: _isLoading
                          ? const CircularProgressIndicator(color: Colors.white)
                          : const Text(
                              'Đăng Nhập',
                              style:
                                  TextStyle(fontSize: 18, color: Colors.white),
                            ),
                    ),
                  ),
                  const SizedBox(height: 30),
                  // Google Sign In Button
                  SizedBox(
                    width: double.infinity,
                    height: 50,
                    child: ElevatedButton.icon(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.white,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(30),
                          side: const BorderSide(color: Colors.orange),
                        ),
                      ),
                      icon: Image.network(
                        'https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_2013_Google.png',
                        height: 24,
                      ),
                      label: const Text(
                        'Đăng nhập bằng Google',
                        style: TextStyle(
                            color: Colors.orange, fontWeight: FontWeight.bold),
                      ),
                      onPressed: () async {
                        final user = await AuthService().signInWithGoogle();
                        Navigator.pushReplacement(
                          context,
                          MaterialPageRoute(
                              builder: (context) => const HomeUser()),
                        );
                      },
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Sign Up
                  Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Text('Bạn chưa có tài khoản?'),
                      TextButton(
                        onPressed: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                                builder: (context) => const RegisterScreen()),
                          );
                        },
                        child: const Text(
                          'Đăng ký',
                          style: TextStyle(color: Colors.orange),
                        ),
                      ),
                    ],
                  ),
                ],
              )
            : Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  const SizedBox(height: 20),
                  const Text(
                    'Quên mật khẩu',
                    style: TextStyle(
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                      color: Colors.orange,
                    ),
                  ),
                  const SizedBox(height: 30),
                  if (_forgotStep == 0) ...[
                    TextField(
                      controller: _forgotEmailController,
                      decoration: const InputDecoration(
                        labelText: 'Nhập email đã đăng ký',
                        border: OutlineInputBorder(),
                      ),
                      keyboardType: TextInputType.emailAddress,
                    ),
                    const SizedBox(height: 24),
                    SizedBox(
                      width: double.infinity,
                      height: 50,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.orange),
                        child: const Text('Gửi mã xác thực'),
                        onPressed: _sendForgotPasswordEmail,
                      ),
                    ),
                    TextButton(
                      onPressed: () {
                        setState(() {
                          _showForgotPassword = false;
                          _forgotStep = 0;
                        });
                      },
                      child: const Text('Quay lại đăng nhập'),
                    ),
                  ] else if (_forgotStep == 1) ...[
                    Text('Nhập mã xác thực đã gửi về email: $_resetEmail',
                        style: const TextStyle(color: Colors.black87)),
                    const SizedBox(height: 20),
                    TextField(
                      controller: _resetCodeController,
                      decoration: const InputDecoration(
                          labelText: 'Mã xác thực (code)',
                          border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 24),
                    SizedBox(
                      width: double.infinity,
                      height: 50,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.orange),
                        child: const Text('Xác thực mã'),
                        onPressed: _verifyCode,
                      ),
                    ),
                    const SizedBox(height: 12), // Spacing added
                    SizedBox(
                      width: double.infinity,
                      height: 50,
                      child: TextButton(
                        onPressed: () {
                          // Gửi lại mã xác thực về email đã nhập
                          _forgotEmailController.text = _resetEmail;
                          _sendForgotPasswordEmail();
                        },
                        child: const Text('Gửi lại mã',
                            style: TextStyle(color: Colors.orange)),
                      ),
                    ),
                    TextButton(
                      onPressed: () {
                        setState(() {
                          _showForgotPassword = false;
                          _forgotStep = 0;
                        });
                      },
                      child: const Text('Quay lại đăng nhập'),
                    ),
                  ] else if (_forgotStep == 2) ...[
                    Text('Nhập mật khẩu mới cho tài khoản: $_resetEmail',
                        style: const TextStyle(color: Colors.black87)),
                    const SizedBox(height: 20),
                    TextField(
                      controller: _resetPasswordController,
                      obscureText: true,
                      decoration: const InputDecoration(
                          labelText: 'Mật khẩu mới',
                          border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 16),
                    TextField(
                      controller: _resetConfirmController,
                      obscureText: true,
                      decoration: const InputDecoration(
                          labelText: 'Nhập lại mật khẩu mới',
                          border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 24),
                    Row(
                      children: [
                        Expanded(
                          child: ElevatedButton(
                            style: ElevatedButton.styleFrom(
                                backgroundColor: Colors.orange),
                            child: const Text('Đặt lại mật khẩu'),
                            onPressed: _resetPassword,
                          ),
                        ),
                        const SizedBox(width: 16),
                        TextButton(
                          onPressed: () {
                            setState(() {
                              _showForgotPassword = false;
                              _forgotStep = 0;
                            });
                          },
                          child: const Text('Quay lại đăng nhập'),
                        ),
                      ],
                    ),
                  ],
                ],
              ),
      ),
    );
  }
}


---

_**Assistant**_

Bạn đã triển khai đúng luồng quên mật khẩu với các bước:
- Nhập email → gửi mã xác thực → nhập mã → nhập mật khẩu mới.

Tuy nhiên, API xác thực mã OTP của bạn là `/api/v1/auth/verify`, không phải `/verify-reset-code`.  
Bạn nên cập nhật lại hàm `_verifyCode` như sau:

````dart
Future<void> _verifyCode() async {
  final code = _resetCodeController.text.trim();
  if (code.isEmpty) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Vui lòng nhập mã xác thực!')),
    );
    return;
  }
  try {
    final response = await http.post(
      Uri.parse('https://food-app-cweu.onrender.com/api/v1/auth/verify'),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({'email': _resetEmail, 'code': code}),
    );
    if (response.statusCode == 200) {
      setState(() {
        _forgotStep = 2;
      });
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
            content: Text('Mã xác thực đúng. Vui lòng nhập mật khẩu mới!')),
      );
    } else {
      String errorMsg = 'Mã xác thực không đúng!';
      try {
        final err = jsonDecode(response.body);
        if (err is Map && err['message'] != null) {
          errorMsg = err['message'].toString();
        }
      } catch (_) {}
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(errorMsg)),
      );
    }
  } catch (e) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Lỗi: $e')),
    );
  }
}
````

**Tóm lại:**  
- Đổi endpoint xác thực mã OTP thành `/api/v1/auth/verify` trong `_verifyCode`.
- Các phần còn lại đã đúng, không cần thay đổi gì thêm.  
- Khi nhấn "Gửi mã xác thực", app sẽ tự động chuyển sang trang nhập mã OTP như yêu cầu.

---

_**User**_

tại sao vẫn chưa hiện trang nhập mã otp

---

_**Assistant**_

Bạn đã code đúng luồng chuyển bước nhập mã OTP bằng biến `_forgotStep`.  
Nếu sau khi nhấn "Gửi mã xác thực" mà **không hiện trang nhập mã OTP**, có thể do một trong các nguyên nhân sau:

### 1. API gửi mã xác thực trả về lỗi
Nếu API `/api/v1/auth/forgot-password` trả về lỗi (không phải status code 200), biến `_forgotStep` sẽ **không được set sang 1** nên không chuyển trang.  
**Cách kiểm tra:**  
- Xem có hiện SnackBar báo lỗi không.
- Kiểm tra lại email nhập vào có đúng và đã đăng ký chưa.

### 2. Giao diện không cập nhật lại
Nếu không gọi `setState` đúng chỗ, UI sẽ không cập nhật.  
**Nhưng trong code của bạn đã có `setState(() { _forgotStep = 1; ... })` nên đã đúng.**

### 3. Đang nhập email chưa đăng ký hoặc sai định dạng
API sẽ trả về lỗi, không chuyển bước.

---

**Cách kiểm tra nhanh:**  
- Thử nhập email đã đăng ký, nhấn "Gửi mã xác thực".
- Nếu có SnackBar báo lỗi, hãy đọc kỹ nội dung lỗi.
- Nếu không có lỗi mà vẫn không chuyển trang, thử hot reload lại app.

---

### Gợi ý sửa/tăng debug

Bạn có thể thêm debug log để kiểm tra response:

````dart
final response = await http.post(
  Uri.parse('https://food-app-cweu.onrender.com/api/v1/auth/forgot-password'),
  headers: {'Content-Type': 'application/json'},
  body: jsonEncode({'email': email}),
);
debugPrint('Forgot password response: ${response.statusCode} - ${response.body}');
````

**Tóm lại:**  
- Nếu API trả về 200, chắc chắn sẽ chuyển sang trang nhập mã OTP.
- Nếu không, hãy kiểm tra lại email và response trả về từ server.

Nếu vẫn không được, hãy gửi log hoặc nội dung SnackBar báo lỗi để mình hỗ trợ chi tiết hơn!

---

_**User**_

vẫn chưa được khi nhấn vào button gửi mã xác thực sẽ chuyển trang nhập mã otp I/ViewRootImpl@9049e52[MainActivity](31101): mWNT: merge t to BBQ
I/ViewRootImpl@9049e52[MainActivity](31101): mWNT: t = android.view.SurfaceControl$Transaction@c7dc28c fN = 13 android.view.SyncRtSurfaceTransactionApplier.applyTransaction:94 android.view.SyncRtSurfaceTransactionApplier.lambda$scheduleApply$0$SyncRtSurfaceTransactionApplier:71 android.view.SyncRtSurfaceTransactionApplier$$ExternalSyntheticLambda0.onFrameDraw:4
I/ViewRootImpl@9049e52[MainActivity](31101): mWNT: merge t to BBQ
D/InputConnectionAdaptor(31101): The input method toggled text monitoring on
D/InputConnectionAdaptor(31101): The input method toggled text monitoring off
I/ViewRootImpl(31101): updatePointerIcon pointerType = 1000, calling pid = 31101
D/InputManager(31101): setPointerIconType iconId = 1000, callingPid = 31101
I/ViewRootImpl(31101): updatePointerIcon pointerType = 1000, calling pid = 31101
D/InputManager(31101): setPointerIconType iconId = 1000, callingPid = 31101

---

_**Assistant**_

Dựa vào code bạn gửi, **khi nhấn "Gửi mã xác thực"**, nếu API trả về status 200 thì UI sẽ chuyển sang bước nhập mã OTP (`_forgotStep = 1`).  
Nếu vẫn không chuyển trang, có thể do một trong các nguyên nhân sau:

---

### 1. **API không trả về status 200**
- Nếu email chưa đăng ký hoặc server trả lỗi, UI sẽ không chuyển bước.
- Hãy thử in log response để kiểm tra:

````dart
final response = await http.post(
  Uri.parse('https://food-app-cweu.onrender.com/api/v1/auth/forgot-password'),
  headers: {'Content-Type': 'application/json'},
  body: jsonEncode({'email': email}),
);
debugPrint('Forgot password response: ${response.statusCode} - ${response.body}');
````

---

### 2. **UI không cập nhật**
- Bạn đã dùng `setState`, nên nếu không chuyển trang thì chắc chắn là do API trả lỗi.

---

### 3. **Kiểm tra lại biến điều kiện**
- Trong phần build UI, điều kiện đã đúng:
  ```dart
  if (_forgotStep == 0) ... // nhập email
  else if (_forgotStep == 1) ... // nhập mã OTP
  else if (_forgotStep == 2) ... // nhập mật khẩu mới
  ```

---

### 4. **Kiểm tra SnackBar**
- Nếu có SnackBar báo lỗi, hãy đọc kỹ nội dung để biết lý do.

---

## **Cách khắc phục nhanh**

1. **Thêm debug log** vào ngay sau khi nhận response ở `_sendForgotPasswordEmail`:

````dart
final response = await http.post(
  Uri.parse('https://food-app-cweu.onrender.com/api/v1/auth/forgot-password'),
  headers: {'Content-Type': 'application/json'},
  body: jsonEncode({'email': email}),
);
debugPrint('Forgot password response: ${response.statusCode} - ${response.body}');
````

2. **Kiểm tra log** trên debug console khi nhấn "Gửi mã xác thực".

3. **Đảm bảo email nhập đúng và đã đăng ký**.

---

**Tóm lại:**  
- Nếu API trả về 200, UI chắc chắn sẽ chuyển sang nhập mã OTP.
- Nếu không, hãy kiểm tra log và nội dung SnackBar để biết lý do.
- Nếu vẫn không được, gửi lại log debug hoặc nội dung lỗi để mình hỗ trợ tiếp.

Nếu bạn cần, hãy gửi log debug khi nhấn "Gửi mã xác thực" để mình xem chi tiết hơn!

---

_**User**_

kiểm tra cập nhật import 'package:flutter/material.dart';
import 'package:food_app_flutter/services/auth_service.dart';
import 'register_screen.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import '../pages_user/home_user.dart';
import '../admin/admin_home.dart';
// import '../admin/quan_ly_nguoi_dung.dart';
import '../admin/quan_ly_thong_ke.dart';

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  // Trạng thái hiển thị form reset password trên giao diện
  bool _showForgotPassword = false;
  int _forgotStep = 0; // 0: nhập email, 1: nhập mã, 2: nhập mật khẩu mới
  String _resetEmail = '';
  final TextEditingController _forgotEmailController = TextEditingController();
  final TextEditingController _resetCodeController = TextEditingController();
  final TextEditingController _resetPasswordController =
      TextEditingController();
  final TextEditingController _resetConfirmController = TextEditingController();

  Future<void> _sendForgotPasswordEmail() async {
    final email = _forgotEmailController.text.trim().toLowerCase();
    if (email.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Vui lòng nhập email!')),
      );
      return;
    }
    try {
      // ...existing code...
      final response = await http.post(
        Uri.parse(
            'https://food-app-cweu.onrender.com/api/v1/auth/forgot-password'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'email': email}),
      );
// ...existing code...
      if (response.statusCode == 200) {
        setState(() {
          _forgotStep = 1;
          _resetEmail = email;
        });
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
              content: Text(
                  'Đã gửi email đặt lại mật khẩu! Vui lòng kiểm tra email để lấy mã xác thực.')),
        );
      } else {
        String errorMsg = 'Lỗi: ${response.statusCode}';
        try {
          final err = jsonDecode(response.body);
          if (err is Map && err['message'] != null) {
            errorMsg = err['message'].toString();
          }
        } catch (_) {}
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMsg)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: $e')),
      );
    }
  }

  Future<void> _verifyCode() async {
    final code = _resetCodeController.text.trim();
    if (code.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Vui lòng nhập mã xác thực!')),
      );
      return;
    }
    try {
      final response = await http.post(
        Uri.parse('https://food-app-cweu.onrender.com/api/v1/auth/verify'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'email': _resetEmail, 'code': code}),
      );
      if (response.statusCode == 200) {
        setState(() {
          _forgotStep = 2;
        });
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
              content: Text('Mã xác thực đúng. Vui lòng nhập mật khẩu mới!')),
        );
      } else {
        String errorMsg = 'Mã xác thực không đúng!';
        try {
          final err = jsonDecode(response.body);
          if (err is Map && err['message'] != null) {
            errorMsg = err['message'].toString();
          }
        } catch (_) {}
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMsg)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: $e')),
      );
    }
  }

  Future<void> _resetPassword() async {
    final pass = _resetPasswordController.text.trim();
    final confirm = _resetConfirmController.text.trim();
    if (pass.isEmpty || confirm.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Vui lòng nhập đủ thông tin!')),
      );
      return;
    }
    if (pass != confirm) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Mật khẩu nhập lại không khớp!')),
      );
      return;
    }
    try {
      final response = await http.post(
        Uri.parse(
            'https://food-app-cweu.onrender.com/api/v1/auth/reset-password'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({
          'email': _resetEmail,
          'code': _resetCodeController.text.trim(),
          'newPassword': pass,
        }),
      );
      debugPrint(
          'Forgot password response: ${response.statusCode} - ${response.body}');
      if (response.statusCode == 200) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Đặt lại mật khẩu thành công!')),
        );
        setState(() {
          _showForgotPassword = false;
          _forgotStep = 0;
        });
      } else {
        String errorMsg = 'Lỗi: ${response.statusCode}';
        try {
          final err = jsonDecode(response.body);
          if (err is Map && err['message'] != null) {
            errorMsg = err['message'].toString();
          }
        } catch (_) {}
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMsg)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: $e')),
      );
    }
  }

  Future<void> _showResetPasswordDialog(String email) async {
    final codeController = TextEditingController();
    final passwordController = TextEditingController();
    final confirmController = TextEditingController();
    String? snackMessage;
    await showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => AlertDialog(
        title: const Text('Đặt lại mật khẩu'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: codeController,
              decoration:
                  const InputDecoration(labelText: 'Mã xác thực (code)'),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: passwordController,
              obscureText: true,
              decoration: const InputDecoration(labelText: 'Mật khẩu mới'),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: confirmController,
              obscureText: true,
              decoration:
                  const InputDecoration(labelText: 'Nhập lại mật khẩu mới'),
            ),
          ],
        ),
        actions: [
          TextButton(
            child: const Text('Hủy'),
            onPressed: () => Navigator.pop(context),
          ),
          ElevatedButton(
            style: ElevatedButton.styleFrom(backgroundColor: Colors.orange),
            child: const Text('Đặt lại'),
            onPressed: () async {
              final code = codeController.text.trim();
              final pass = passwordController.text.trim();
              final confirm = confirmController.text.trim();
              if (code.isEmpty || pass.isEmpty || confirm.isEmpty) {
                snackMessage = 'Vui lòng nhập đủ thông tin!';
                Navigator.pop(context);
                return;
              }
              if (pass != confirm) {
                snackMessage = 'Mật khẩu nhập lại không khớp!';
                Navigator.pop(context);
                return;
              }
              try {
                final response = await http.post(
                  Uri.parse(
                      'https://food-app-cweu.onrender.com/api/v1/auth/reset-password'),
                  headers: {'Content-Type': 'application/json'},
                  body: jsonEncode({
                    'email': email,
                    'code': code,
                    'newPassword': pass,
                  }),
                );
                if (response.statusCode == 200) {
                  snackMessage = 'Đặt lại mật khẩu thành công!';
                } else {
                  String errorMsg = 'Lỗi: ${response.statusCode}';
                  try {
                    final err = jsonDecode(response.body);
                    if (err is Map && err['message'] != null) {
                      errorMsg = err['message'].toString();
                    }
                  } catch (_) {}
                  snackMessage = errorMsg;
                }
              } catch (e) {
                snackMessage = 'Lỗi: $e';
              }
              Navigator.pop(context);
            },
          ),
        ],
      ),
    );
    if (snackMessage != null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(snackMessage!)),
      );
    }
  }

  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();
  bool _isLoading = false;
  bool _obscurePassword = true;

  Future<void> _login() async {
    setState(() {
      _isLoading = true;
    });
    final email = _emailController.text.trim();
    final password = _passwordController.text.trim();
    if (email.isEmpty || password.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
            content: Text('Vui lòng nhập đầy đủ email và mật khẩu!')),
      );
      setState(() {
        _isLoading = false;
      });
      return;
    }
    try {
      final response = await http.post(
        Uri.parse('https://food-app-cweu.onrender.com/api/v1/auth/login'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'email': email, 'password': password}),
      );
      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        debugPrint('Login response: ${response.body}');
        // In ra toàn bộ data để kiểm tra cấu trúc
        debugPrint('Login data: $data');
        var user = data['data'];
        // Thử lấy token từ nhiều trường phổ biến
        String? accessToken = '';
        if (data['accessToken'] != null)
          accessToken = data['accessToken'];
        else if (data['token'] != null)
          accessToken = data['token'];
        else if (user?['accessToken'] != null)
          accessToken = user?['accessToken'];
        else if (user?['token'] != null) accessToken = user?['token'];
        debugPrint('AccessToken to save: $accessToken');
        if (accessToken != null && accessToken.toString().isNotEmpty) {
          final prefs = await SharedPreferences.getInstance();
          await prefs.setString('token', accessToken.toString());
        }
        if (user != null) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Đăng nhập thành công!')),
          );
          await Future.delayed(const Duration(milliseconds: 500));
          // Lấy role từ user object, có thể là 'role', 'userRole', hoặc 'type'
          final role =
              user['role'] ?? user['userRole'] ?? user['type'] ?? 'user';
          // ...existing code...
          // ...existing code...
          if (role == 'admin') {
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(
                builder: (context) => AdminHome(
                  userRole: role,
                  userEmail: user['email'] ?? '',
                ),
              ),
            );
          } else {
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(builder: (context) => const HomeUser()),
            );
          }
// ...existing code...
// ...existing code...
        } else {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
                content: Text('Không tìm thấy thông tin người dùng!')),
          );
        }
      } else {
        String errorMessage = 'Đăng nhập thất bại: ${response.statusCode}';
        try {
          final errorData = jsonDecode(response.body);
          if (errorData['message'] != null) {
            errorMessage = errorData['message'].toString();
          } else if (response.statusCode == 401) {
            errorMessage = 'Sai email hoặc mật khẩu.';
          } else if (response.statusCode == 404) {
            errorMessage = 'Tài khoản không tồn tại hoặc chưa đăng ký.';
          }
        } catch (_) {
          // Nếu không parse được JSON thì giữ nguyên errorMessage
        }
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMessage)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: $e')),
      );
    }
    setState(() {
      _isLoading = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: SingleChildScrollView(
        padding: const EdgeInsets.symmetric(horizontal: 25, vertical: 60),
        child: !_showForgotPassword
            ? Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  const SizedBox(height: 20),
                  const Text(
                    'Đăng Nhập KFC FOOD',
                    style: TextStyle(
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                      color: Colors.orange,
                    ),
                  ),
                  const SizedBox(height: 40),
                  // Email Field
                  TextField(
                    controller: _emailController,
                    decoration: InputDecoration(
                      labelText: 'Email',
                      prefixIcon: const Icon(Icons.email, color: Colors.orange),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(30),
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Password Field
                  TextField(
                    controller: _passwordController,
                    obscureText: _obscurePassword,
                    decoration: InputDecoration(
                      labelText: 'Mật Khẩu',
                      prefixIcon: const Icon(Icons.lock, color: Colors.orange),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(30),
                      ),
                      suffixIcon: IconButton(
                        icon: Icon(
                          _obscurePassword
                              ? Icons.visibility_off
                              : Icons.visibility,
                          color: Colors.orange,
                        ),
                        onPressed: () {
                          setState(() {
                            _obscurePassword = !_obscurePassword;
                          });
                        },
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Forgot password
                  Align(
                    alignment: Alignment.centerRight,
                    child: TextButton(
                      onPressed: _isLoading
                          ? null
                          : () {
                              setState(() {
                                _showForgotPassword = true;
                                _forgotStep = 0;
                                _forgotEmailController.clear();
                                _resetCodeController.clear();
                                _resetPasswordController.clear();
                                _resetConfirmController.clear();
                              });
                            },
                      child: const Text(
                        'Quên mật khẩu?',
                        style: TextStyle(color: Colors.orange),
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Login Button
                  SizedBox(
                    width: double.infinity,
                    height: 50,
                    child: ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.orange,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(30),
                        ),
                      ),
                      onPressed: _isLoading ? null : _login,
                      child: _isLoading
                          ? const CircularProgressIndicator(color: Colors.white)
                          : const Text(
                              'Đăng Nhập',
                              style:
                                  TextStyle(fontSize: 18, color: Colors.white),
                            ),
                    ),
                  ),
                  const SizedBox(height: 30),
                  // Google Sign In Button
                  SizedBox(
                    width: double.infinity,
                    height: 50,
                    child: ElevatedButton.icon(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.white,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(30),
                          side: const BorderSide(color: Colors.orange),
                        ),
                      ),
                      icon: Image.network(
                        'https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_2013_Google.png',
                        height: 24,
                      ),
                      label: const Text(
                        'Đăng nhập bằng Google',
                        style: TextStyle(
                            color: Colors.orange, fontWeight: FontWeight.bold),
                      ),
                      onPressed: () async {
                        final user = await AuthService().signInWithGoogle();
                        Navigator.pushReplacement(
                          context,
                          MaterialPageRoute(
                              builder: (context) => const HomeUser()),
                        );
                      },
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Sign Up
                  Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Text('Bạn chưa có tài khoản?'),
                      TextButton(
                        onPressed: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                                builder: (context) => const RegisterScreen()),
                          );
                        },
                        child: const Text(
                          'Đăng ký',
                          style: TextStyle(color: Colors.orange),
                        ),
                      ),
                    ],
                  ),
                ],
              )
            : Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  const SizedBox(height: 20),
                  const Text(
                    'Quên mật khẩu',
                    style: TextStyle(
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                      color: Colors.orange,
                    ),
                  ),
                  const SizedBox(height: 30),
                  if (_forgotStep == 0) ...[
                    TextField(
                      controller: _forgotEmailController,
                      decoration: const InputDecoration(
                        labelText: 'Nhập email đã đăng ký',
                        border: OutlineInputBorder(),
                      ),
                      keyboardType: TextInputType.emailAddress,
                    ),
                    const SizedBox(height: 24),
                    SizedBox(
                      width: double.infinity,
                      height: 50,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.orange),
                        child: const Text('Gửi mã xác thực'),
                        onPressed: _sendForgotPasswordEmail,
                      ),
                    ),
                    TextButton(
                      onPressed: () {
                        setState(() {
                          _showForgotPassword = false;
                          _forgotStep = 0;
                        });
                      },
                      child: const Text('Quay lại đăng nhập'),
                    ),
                  ] else if (_forgotStep == 1) ...[
                    Text('Nhập mã xác thực đã gửi về email: $_resetEmail',
                        style: const TextStyle(color: Colors.black87)),
                    const SizedBox(height: 20),
                    TextField(
                      controller: _resetCodeController,
                      decoration: const InputDecoration(
                          labelText: 'Mã xác thực (code)',
                          border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 24),
                    SizedBox(
                      width: double.infinity,
                      height: 50,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.orange),
                        child: const Text('Xác thực mã'),
                        onPressed: _verifyCode,
                      ),
                    ),
                    const SizedBox(height: 12), // Spacing added
                    SizedBox(
                      width: double.infinity,
                      height: 50,
                      child: TextButton(
                        onPressed: () {
                          // Gửi lại mã xác thực về email đã nhập
                          _forgotEmailController.text = _resetEmail;
                          _sendForgotPasswordEmail();
                        },
                        child: const Text('Gửi lại mã',
                            style: TextStyle(color: Colors.orange)),
                      ),
                    ),
                    TextButton(
                      onPressed: () {
                        setState(() {
                          _showForgotPassword = false;
                          _forgotStep = 0;
                        });
                      },
                      child: const Text('Quay lại đăng nhập'),
                    ),
                  ] else if (_forgotStep == 2) ...[
                    Text('Nhập mật khẩu mới cho tài khoản: $_resetEmail',
                        style: const TextStyle(color: Colors.black87)),
                    const SizedBox(height: 20),
                    TextField(
                      controller: _resetPasswordController,
                      obscureText: true,
                      decoration: const InputDecoration(
                          labelText: 'Mật khẩu mới',
                          border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 16),
                    TextField(
                      controller: _resetConfirmController,
                      obscureText: true,
                      decoration: const InputDecoration(
                          labelText: 'Nhập lại mật khẩu mới',
                          border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 24),
                    Row(
                      children: [
                        Expanded(
                          child: ElevatedButton(
                            style: ElevatedButton.styleFrom(
                                backgroundColor: Colors.orange),
                            child: const Text('Đặt lại mật khẩu'),
                            onPressed: _resetPassword,
                          ),
                        ),
                        const SizedBox(width: 16),
                        TextButton(
                          onPressed: () {
                            setState(() {
                              _showForgotPassword = false;
                              _forgotStep = 0;
                            });
                          },
                          child: const Text('Quay lại đăng nhập'),
                        ),
                      ],
                    ),
                  ],
                ],
              ),
      ),
    );
  }
}


---

_**Assistant**_

Các import ở đầu file `LoginScreen` của bạn đã đúng và đầy đủ cho chức năng hiện tại:

````dart
import 'package:flutter/material.dart';
import 'package:food_app_flutter/services/auth_service.dart';
import 'register_screen.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import '../pages_user/home_user.dart';
import '../admin/admin_home.dart';
// import '../admin/quan_ly_nguoi_dung.dart';
import '../admin/quan_ly_thong_ke.dart';
````

- Không cần sửa gì thêm ở phần import.
- Nếu bạn không dùng `quan_ly_nguoi_dung.dart`, giữ nguyên dòng import đã comment.

Bạn có thể xem lại file tại `login_screen.dart`.

---

_**User**_

khi nhấn vào button gửi mã xác nhận sẽ chuyển trang nhập mã otp

---

_**Assistant**_

Bạn đã code đúng logic: khi nhấn button "Gửi mã xác thực", hàm `_sendForgotPasswordEmail` sẽ được gọi. Nếu API trả về status 200, biến `_forgotStep` sẽ được set sang 1 và UI sẽ chuyển sang trang nhập mã OTP.

**Nếu vẫn không chuyển trang**, hãy kiểm tra lại như sau:

1. **Thêm debug log để chắc chắn hàm được gọi và response đúng:**

````dart
final response = await http.post(
  Uri.parse('https://food-app-cweu.onrender.com/api/v1/auth/forgot-password'),
  headers: {'Content-Type': 'application/json'},
  body: jsonEncode({'email': email}),
);
debugPrint('Forgot password response: ${response.statusCode} - ${response.body}');
````

2. **Kiểm tra lại điều kiện hiển thị UI:**
- Trong phần build, UI sẽ chuyển sang nhập mã OTP nếu `_showForgotPassword == true && _forgotStep == 1`.

3. **Đảm bảo email nhập đúng và đã đăng ký.**
- Nếu email chưa đăng ký, API sẽ trả lỗi và không chuyển trang.

4. **Kiểm tra SnackBar có báo lỗi gì không.**

---

**Tóm lại:**  
- Nếu API trả về 200, UI chắc chắn sẽ chuyển sang nhập mã OTP.
- Nếu không, hãy kiểm tra log debug và nội dung SnackBar để biết lý do.

Nếu vẫn không được, hãy gửi log debug khi nhấn "Gửi mã xác thực" để mình hỗ trợ chi tiết hơn!

---

_**User**_

đã nhập đúng gmail và gửi otp về gmail nhưng chưa hiện ra trang nhập otp

---

_**Assistant**_

Bạn đã nhập đúng Gmail và nhận được OTP, nhưng **không hiện trang nhập mã OTP**.  
Code của bạn đã đúng logic: nếu API trả về status 200 thì sẽ chuyển sang bước nhập mã OTP (`_forgotStep = 1`).  
Vấn đề có thể do UI không được cập nhật lại hoặc có lỗi ở chỗ khác.

**Hãy thử các bước sau để xác định và khắc phục:**

---

### 1. Thêm debug log để kiểm tra response và bước chuyển

Thêm dòng này vào ngay sau khi nhận response ở `_sendForgotPasswordEmail`:

````dart
final response = await http.post(
  Uri.parse('https://food-app-cweu.onrender.com/api/v1/auth/forgot-password'),
  headers: {'Content-Type': 'application/json'},
  body: jsonEncode({'email': email}),
);
debugPrint('Forgot password response: ${response.statusCode} - ${response.body}');
debugPrint('Current forgotStep: $_forgotStep');
````

---

### 2. Đảm bảo bạn đang ở đúng giao diện "Quên mật khẩu"

Khi nhấn "Quên mật khẩu?", biến `_showForgotPassword` phải là `true`.  
Nếu không, UI sẽ không hiển thị form nhập mã OTP.

---

### 3. Kiểm tra lại phần build UI

Đảm bảo phần build UI có điều kiện đúng:

```dart
if (_forgotStep == 0) ... // nhập email
else if (_forgotStep == 1) ... // nhập mã OTP
else if (_forgotStep == 2) ... // nhập mật khẩu mới
```

---

### 4. Hot reload/hot restart lại app

Đôi khi UI không cập nhật do cache, hãy thử hot restart.

---

### 5. Đảm bảo không có lỗi ở console

Nếu có lỗi ở console, hãy gửi log để mình hỗ trợ.

---

## **Tóm lại**

- Nếu API trả về 200, chắc chắn phải chuyển sang trang nhập mã OTP.
- Nếu không chuyển, hãy kiểm tra lại biến `_showForgotPassword` và `_forgotStep`.
- Thêm debug log để kiểm tra giá trị thực tế.
- Nếu vẫn không được, gửi log debug sau khi nhấn "Gửi mã xác thực" để mình hỗ trợ tiếp.

Bạn chỉ cần thêm debug như hướng dẫn, chạy lại và gửi log nếu vẫn chưa ra trang nhập OTP!

---

_**User**_

cập nhật    try {
                final response = await http.post(
                  Uri.parse(
                      'https://food-app-cweu.onrender.com/api/v1/auth/reset-password'),
                  headers: {'Content-Type': 'application/json'},
                  body: jsonEncode({
                    'email': email,
                    'code': code,
                    'newPassword': pass,
                  }),
                );

---

_**Assistant**_

Bạn nên thêm debug log để kiểm tra response khi gọi API đặt lại mật khẩu, giúp dễ dàng xác định lỗi nếu có.  
Hãy cập nhật đoạn code như sau:

````dart
try {
  final response = await http.post(
    Uri.parse(
        'https://food-app-cweu.onrender.com/api/v1/auth/reset-password'),
    headers: {'Content-Type': 'application/json'},
    body: jsonEncode({
      'email': email,
      'code': code,
      'newPassword': pass,
    }),
  );
  debugPrint('Reset password response: ${response.statusCode} - ${response.body}'); // Thêm dòng này để log kết quả
  if (response.statusCode == 200) {
    snackMessage = 'Đặt lại mật khẩu thành công!';
  } else {
    String errorMsg = 'Lỗi: ${response.statusCode}';
    try {
      final err = jsonDecode(response.body);
      if (err is Map && err['message'] != null) {
        errorMsg = err['message'].toString();
      }
    } catch (_) {}
    snackMessage = errorMsg;
  }
} catch (e) {
  snackMessage = 'Lỗi: $e';
}
````

Sau khi cập nhật, bạn sẽ thấy log chi tiết khi gọi API đặt lại mật khẩu trong debug console.  
Nếu có lỗi, hãy kiểm tra log để biết nguyên nhân.

---

_**User**_

cập nhật cho tôi vào trong file

---

_**Assistant**_

Để dễ debug và đảm bảo khi nhấn "Gửi mã xác thực" sẽ chuyển sang trang nhập mã OTP, bạn hãy thêm log vào hàm `_sendForgotPasswordEmail` như sau:

````dart
Future<void> _sendForgotPasswordEmail() async {
  final email = _forgotEmailController.text.trim().toLowerCase();
  if (email.isEmpty) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Vui lòng nhập email!')),
    );
    return;
  }
  try {
    final response = await http.post(
      Uri.parse(
          'https://food-app-cweu.onrender.com/api/v1/auth/forgot-password'),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({'email': email}),
    );
    debugPrint('Forgot password response: ${response.statusCode} - ${response.body}');
    if (response.statusCode == 200) {
      setState(() {
        _forgotStep = 1;
        _resetEmail = email;
      });
      debugPrint('Chuyển sang bước nhập mã OTP: forgotStep=$_forgotStep');
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
            content: Text(
                'Đã gửi email đặt lại mật khẩu! Vui lòng kiểm tra email để lấy mã xác thực.')),
      );
    } else {
      String errorMsg = 'Lỗi: ${response.statusCode}';
      try {
        final err = jsonDecode(response.body);
        if (err is Map && err['message'] != null) {
          errorMsg = err['message'].toString();
        }
      } catch (_) {}
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(errorMsg)),
      );
    }
  } catch (e) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Lỗi: $e')),
    );
  }
}
````

**Sau khi cập nhật:**  
- Khi nhấn "Gửi mã xác thực", bạn sẽ thấy log trên debug console.
- Nếu API trả về 200, chắc chắn UI sẽ chuyển sang trang nhập mã OTP.

Bạn chỉ cần thay thế nội dung hàm `_sendForgotPasswordEmail` như trên.

---

_**User**_

đã nhận được mã quan gmail nhưng chưa hiện trang nhập I/ViewRootImpl@9049e52[MainActivity](32692): mWNT: merge t to BBQ
I/ViewRootImpl@9049e52[MainActivity](32692): mWNT: t = android.view.SurfaceControl$Transaction@f6330cf fN = 16 android.view.SyncRtSurfaceTransactionApplier.applyTransaction:94 android.view.SyncRtSurfaceTransactionApplier.lambda$scheduleApply$0$SyncRtSurfaceTransactionApplier:71 android.view.SyncRtSurfaceTransactionApplier$$ExternalSyntheticLambda0.onFrameDraw:4
I/ViewRootImpl@9049e52[MainActivity](32692): mWNT: merge t to BBQ
D/InputConnectionAdaptor(32692): The input method toggled text monitoring on
D/InputConnectionAdaptor(32692): The input method toggled text monitoring off

---

_**Assistant**_

Dựa vào video và log bạn gửi, **bạn đã nhận được mã OTP qua Gmail nhưng UI vẫn không chuyển sang trang nhập mã OTP** sau khi nhấn "Gửi mã xác thực".

### Nguyên nhân có thể:
- API trả về thành công nhưng UI không cập nhật lại.
- Có thể do bàn phím ảo che mất phần nhập mã OTP (vì bạn dùng `SingleChildScrollView`).
- Hoặc widget không được rebuild đúng lúc.

---

## Cách khắc phục

### 1. **Thêm dòng sau vào cuối hàm `_sendForgotPasswordEmail` để tự động cuộn lên đầu khi chuyển bước:**

````dart
if (response.statusCode == 200) {
  setState(() {
    _forgotStep = 1;
    _resetEmail = email;
  });
  // Thêm dòng này để cuộn lên đầu, tránh bị bàn phím che
  Scrollable.ensureVisible(context.findRenderObject()!, duration: Duration(milliseconds: 300));
  debugPrint('Chuyển sang bước nhập mã OTP: forgotStep=$_forgotStep');
  ScaffoldMessenger.of(context).showSnackBar(
    const SnackBar(
        content: Text(
            'Đã gửi email đặt lại mật khẩu! Vui lòng kiểm tra email để lấy mã xác thực.')),
  );
}
````

### 2. **Kiểm tra lại điều kiện hiển thị UI**
- Đảm bảo trong hàm `build`, phần nhập mã OTP nằm trong điều kiện:
  ```dart
  else if (_forgotStep == 1) ...[
    // Widget nhập mã OTP
  ]
  ```

### 3. **Thử ẩn bàn phím sau khi gửi mã**
Thêm dòng này sau khi gọi `setState`:
```dart
FocusScope.of(context).unfocus();
```

---

## **Tóm lại**
- UI của bạn đã đúng logic, nhưng có thể bị bàn phím che hoặc chưa scroll lên.
- Hãy thử thêm `Scrollable.ensureVisible` hoặc `FocusScope.of(context).unfocus()` sau khi chuyển bước.
- Nếu vẫn không được, thử thu nhỏ bàn phím hoặc kéo màn hình lên để kiểm tra.

**Nếu vẫn không thấy trang nhập mã OTP, hãy thử thêm log `debugPrint('forgotStep: $_forgotStep');` vào trong hàm `build` để kiểm tra giá trị thực tế khi UI render.**

---

_**User**_

I/ViewRootImpl@9049e52[MainActivity]( 6437): mWNT: merge t to BBQ
D/InputConnectionAdaptor( 6437): The input method toggled text monitoring on
D/InputConnectionAdaptor( 6437): The input method toggled text monitoring off
I/ViewRootImpl( 6437): updatePointerIcon pointerType = 1000, calling pid = 6437
D/InputManager( 6437): setPointerIconType iconId = 1000, callingPid = 6437

---

_**Assistant**_

Dựa vào code và mô tả, logic chuyển trang nhập mã OTP của bạn đã đúng. Tuy nhiên, có thể do UI chưa được cập nhật lại hoặc bàn phím che mất phần nhập mã OTP.

**Để chắc chắn UI chuyển sang trang nhập mã OTP, hãy thêm debug log vào hàm build và unfocus bàn phím sau khi gửi mã xác thực:**

````dart
@override
Widget build(BuildContext context) {
  debugPrint('ForgotStep: $_forgotStep, ShowForgotPassword: $_showForgotPassword'); // Thêm dòng này để log trạng thái
  return Scaffold(
    backgroundColor: Colors.white,
    body: SingleChildScrollView(
      padding: const EdgeInsets.symmetric(horizontal: 25, vertical: 60),
      child: !_showForgotPassword
          ? Column(
              // ...existing code...
            )
          : Column(
              crossAxisAlignment: CrossAxisAlignment.center,
              children: [
                // ...existing code...
              ],
            ),
    ),
  );
}
````

Và trong `_sendForgotPasswordEmail`, sau khi setState chuyển bước, hãy thêm:

````dart
if (response.statusCode == 200) {
  setState(() {
    _forgotStep = 1;
    _resetEmail = email;
  });
  FocusScope.of(context).unfocus(); // Ẩn bàn phím để tránh che UI
  ScaffoldMessenger.of(context).showSnackBar(
    const SnackBar(
        content: Text(
            'Đã gửi email đặt lại mật khẩu! Vui lòng kiểm tra email để lấy mã xác thực.')),
  );
}
````

**Sau khi cập nhật:**
- Khi nhấn "Gửi mã xác thực", bàn phím sẽ tự ẩn và log sẽ hiển thị trạng thái `_forgotStep` trên debug console.
- Nếu `_forgotStep == 1` và `_showForgotPassword == true` mà vẫn không thấy trang nhập mã OTP, hãy kiểm tra lại UI hoặc thử kéo màn hình lên.

Nếu vẫn không được, hãy gửi log debug dòng `ForgotStep: ...` sau khi nhấn "Gửi mã xác thực" để mình hỗ trợ tiếp!

---

_**User**_

I/ViewRootImpl@9049e52[MainActivity]( 8002): mWNT: merge t to BBQ
I/ViewRootImpl@9049e52[MainActivity]( 8002): mWNT: t = android.view.SurfaceControl$Transaction@fe5a165 fN = 18 android.view.SyncRtSurfaceTransactionApplier.applyTransaction:94 android.view.SyncRtSurfaceTransactionApplier.lambda$scheduleApply$0$SyncRtSurfaceTransactionApplier:71 android.view.SyncRtSurfaceTransactionApplier$$ExternalSyntheticLambda0.onFrameDraw:4
I/ViewRootImpl@9049e52[MainActivity]( 8002): mWNT: merge t to BBQ
D/InputConnectionAdaptor( 8002): The input method toggled text monitoring on
D/InputConnectionAdaptor( 8002): The input method toggled text monitoring off

---

_**Assistant**_

Code của bạn đã đúng logic chuyển bước nhập mã OTP, nhưng có thể UI chưa cập nhật hoặc bị che khuất. Để chắc chắn UI chuyển sang trang nhập mã OTP, bạn nên:

1. **Thêm debug log vào hàm build** để kiểm tra giá trị `_forgotStep` và `_showForgotPassword` mỗi lần UI render.
2. **Ẩn bàn phím sau khi gửi mã xác thực** để tránh bị che UI.

Cập nhật như sau:

````dart
@override
Widget build(BuildContext context) {
  debugPrint('ForgotStep: $_forgotStep, ShowForgotPassword: $_showForgotPassword');
  return Scaffold(
    backgroundColor: Colors.white,
    body: SingleChildScrollView(
      padding: const EdgeInsets.symmetric(horizontal: 25, vertical: 60),
      child: !_showForgotPassword
          ? Column(
              // ...existing code...
            )
          : Column(
              crossAxisAlignment: CrossAxisAlignment.center,
              children: [
                // ...existing code...
              ],
            ),
    ),
  );
}

// Trong _sendForgotPasswordEmail, sau khi setState:
if (response.statusCode == 200) {
  setState(() {
    _forgotStep = 1;
    _resetEmail = email;
  });
  FocusScope.of(context).unfocus(); // Ẩn bàn phím
  debugPrint('Chuyển sang bước nhập mã OTP: forgotStep=$_forgotStep');
  ScaffoldMessenger.of(context).showSnackBar(
    const SnackBar(
        content: Text(
            'Đã gửi email đặt lại mật khẩu! Vui lòng kiểm tra email để lấy mã xác thực.')),
  );
}
````

**Sau khi cập nhật:**
- Khi nhấn "Gửi mã xác thực", kiểm tra debug console để xem log `ForgotStep: ...`.
- Nếu `_forgotStep == 1` và `_showForgotPassword == true` mà vẫn không thấy trang nhập mã OTP, hãy thử kéo màn hình lên hoặc thu nhỏ bàn phím.

Nếu vẫn không được, gửi lại log debug dòng `ForgotStep: ...` sau khi nhấn "Gửi mã xác thực" để mình hỗ trợ tiếp!

---

_**User**_

I/ViewRootImpl@9049e52[MainActivity]( 9802): mWNT: merge t to BBQ
I/IMM_LC  ( 9802): notifyImeHidden
I/ViewRootImpl@9049e52[MainActivity]( 9802): mWNT: t = android.view.SurfaceControl$Transaction@4655251 fN = 31 android.view.SyncRtSurfaceTransactionApplier.applyTransaction:94 android.view.SyncRtSurfaceTransactionApplier.lambda$scheduleApply$0$SyncRtSurfaceTransactionApplier:71 android.view.SyncRtSurfaceTransactionApplier$$ExternalSyntheticLambda0.onFrameDraw:4
I/ViewRootImpl@9049e52[MainActivity]( 9802): mWNT: merge t to BBQ
I/ViewRootImpl( 9802): updatePointerIcon pointerType = 1000, calling pid = 9802
D/InputManager( 9802): setPointerIconType iconId = 1000, callingPid = 9802
I/ViewRootImpl( 9802): updatePointerIcon pointerType = 1000, calling pid = 9802
D/InputManager( 9802): setPointerIconType iconId = 1000, callingPid = 9802

---

_**Assistant**_

Dựa vào code bạn gửi, **logic chuyển sang trang nhập mã OTP đã đúng**. Tuy nhiên, nếu UI vẫn không chuyển, hãy kiểm tra lại các điểm sau:

---

### 1. **Kiểm tra log debug trong hàm build**

Bạn đã có dòng:
```dart
debugPrint('ForgotStep: $_forgotStep, ShowForgotPassword: $_showForgotPassword');
```
Hãy **xem log trên debug console** sau khi nhấn "Gửi mã xác thực".  
- Nếu log ra `ForgotStep: 1, ShowForgotPassword: true` mà UI vẫn không đổi, thì có thể do hot reload bị lỗi hoặc widget bị cache.
- Nếu log ra `ForgotStep: 0`, nghĩa là biến chưa được cập nhật đúng.

---

### 2. **Đảm bảo không bị che UI**

Sau khi nhấn "Gửi mã xác thực", bạn đã có:
```dart
FocusScope.of(context).unfocus();
```
Điều này sẽ ẩn bàn phím, tránh che phần nhập mã OTP.

---

### 3. **Kiểm tra lại điều kiện hiển thị UI**

Bạn đã có:
```dart
if (_forgotStep == 0) ...[ // nhập email ]
else if (_forgotStep == 1) ...[ // nhập mã OTP ]
else if (_forgotStep == 2) ...[ // nhập mật khẩu mới ]
```
Nếu `_forgotStep` đã là 1, UI chắc chắn sẽ hiện phần nhập mã OTP.

---

### 4. **Thử hot restart lại app**

Đôi khi hot reload không cập nhật đúng state, hãy thử **hot restart** (khởi động lại app).

---

### 5. **Kiểm tra lại widget cha**

Đảm bảo widget cha không bị rebuild lại hoặc giữ state cũ.

---

## **Tóm lại**

- Nếu log debug ra đúng `_forgotStep: 1` và `_showForgotPassword: true` mà UI vẫn không đổi, hãy thử hot restart app.
- Nếu log không đúng, hãy kiểm tra lại hàm `_sendForgotPasswordEmail` và các chỗ setState.
- Nếu vẫn không được, gửi log debug dòng `ForgotStep: ...` sau khi nhấn "Gửi mã xác thực" để mình hỗ trợ tiếp!

**Bạn đã làm đúng logic, chỉ cần kiểm tra lại log và thử hot restart là sẽ thấy trang nhập mã OTP.**

---

_**User**_

sao vẫn chưa được kiểm tra import 'package:flutter/material.dart';
import 'package:food_app_flutter/services/auth_service.dart';
import 'register_screen.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import '../pages_user/home_user.dart';
import '../admin/admin_home.dart';
// import '../admin/quan_ly_nguoi_dung.dart';
import '../admin/quan_ly_thong_ke.dart';

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  // Trạng thái hiển thị form reset password trên giao diện
  bool _showForgotPassword = false;
  int _forgotStep = 0; // 0: nhập email, 1: nhập mã, 2: nhập mật khẩu mới
  String _resetEmail = '';
  final TextEditingController _forgotEmailController = TextEditingController();
  final TextEditingController _resetCodeController = TextEditingController();
  final TextEditingController _resetPasswordController =
      TextEditingController();
  final TextEditingController _resetConfirmController = TextEditingController();

  Future<void> _sendForgotPasswordEmail() async {
    final email = _forgotEmailController.text.trim().toLowerCase();
    if (email.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Vui lòng nhập email!')),
      );
      return;
    }
    try {
      final response = await http.post(
        Uri.parse(
            'https://food-app-cweu.onrender.com/api/v1/auth/forgot-password'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'email': email}),
      );
      if (response.statusCode == 200) {
        setState(() {
          _forgotStep = 1;
          _resetEmail = email;
        });
        FocusScope.of(context).unfocus();
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
              content: Text(
                  'Đã gửi email đặt lại mật khẩu! Vui lòng kiểm tra email để lấy mã xác thực.')),
        );
      } else {
        String errorMsg = 'Lỗi: ${response.statusCode}';
        try {
          final err = jsonDecode(response.body);
          if (err is Map && err['message'] != null) {
            errorMsg = err['message'].toString();
          }
        } catch (_) {}
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMsg)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: $e')),
      );
    }
  }

  Future<void> _verifyCode() async {
    final code = _resetCodeController.text.trim();
    if (code.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Vui lòng nhập mã xác thực!')),
      );
      return;
    }
    try {
      final response = await http.post(
        Uri.parse(
            'https://food-app-cweu.onrender.com/api/v1/auth/verify-reset-code'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'email': _resetEmail, 'code': code}),
      );
      if (response.statusCode == 200) {
        setState(() {
          _forgotStep = 2;
        });
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
              content: Text('Mã xác thực đúng. Vui lòng nhập mật khẩu mới!')),
        );
      } else {
        String errorMsg = 'Mã xác thực không đúng!';
        try {
          final err = jsonDecode(response.body);
          if (err is Map && err['message'] != null) {
            errorMsg = err['message'].toString();
          }
        } catch (_) {}
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMsg)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: $e')),
      );
    }
  }

  Future<void> _resetPassword() async {
    final pass = _resetPasswordController.text.trim();
    final confirm = _resetConfirmController.text.trim();
    if (pass.isEmpty || confirm.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Vui lòng nhập đủ thông tin!')),
      );
      return;
    }
    if (pass != confirm) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Mật khẩu nhập lại không khớp!')),
      );
      return;
    }
    try {
      final response = await http.post(
        Uri.parse(
            'https://food-app-cweu.onrender.com/api/v1/auth/reset-password'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({
          'email': _resetEmail,
          'code': _resetCodeController.text.trim(),
          'newPassword': pass,
        }),
      );
      if (response.statusCode == 200) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Đặt lại mật khẩu thành công!')),
        );
        setState(() {
          _showForgotPassword = false;
          _forgotStep = 0;
        });
      } else {
        String errorMsg = 'Lỗi: ${response.statusCode}';
        try {
          final err = jsonDecode(response.body);
          if (err is Map && err['message'] != null) {
            errorMsg = err['message'].toString();
          }
        } catch (_) {}
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMsg)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: $e')),
      );
    }
  }

  Future<void> _showResetPasswordDialog(String email) async {
    final codeController = TextEditingController();
    final passwordController = TextEditingController();
    final confirmController = TextEditingController();
    String? snackMessage;
    await showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => AlertDialog(
        title: const Text('Đặt lại mật khẩu'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: codeController,
              decoration:
                  const InputDecoration(labelText: 'Mã xác thực (code)'),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: passwordController,
              obscureText: true,
              decoration: const InputDecoration(labelText: 'Mật khẩu mới'),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: confirmController,
              obscureText: true,
              decoration:
                  const InputDecoration(labelText: 'Nhập lại mật khẩu mới'),
            ),
          ],
        ),
        actions: [
          TextButton(
            child: const Text('Hủy'),
            onPressed: () => Navigator.pop(context),
          ),
          ElevatedButton(
            style: ElevatedButton.styleFrom(backgroundColor: Colors.orange),
            child: const Text('Đặt lại'),
            onPressed: () async {
              final code = codeController.text.trim();
              final pass = passwordController.text.trim();
              final confirm = confirmController.text.trim();
              if (code.isEmpty || pass.isEmpty || confirm.isEmpty) {
                snackMessage = 'Vui lòng nhập đủ thông tin!';
                Navigator.pop(context);
                return;
              }
              if (pass != confirm) {
                snackMessage = 'Mật khẩu nhập lại không khớp!';
                Navigator.pop(context);
                return;
              }
              try {
                final response = await http.post(
                  Uri.parse(
                      'https://food-app-cweu.onrender.com/api/v1/auth/reset-password'),
                  headers: {'Content-Type': 'application/json'},
                  body: jsonEncode({
                    'email': email,
                    'code': code,
                    'newPassword': pass,
                  }),
                );
                if (response.statusCode == 200) {
                  snackMessage = 'Đặt lại mật khẩu thành công!';
                } else {
                  String errorMsg = 'Lỗi: ${response.statusCode}';
                  try {
                    final err = jsonDecode(response.body);
                    if (err is Map && err['message'] != null) {
                      errorMsg = err['message'].toString();
                    }
                  } catch (_) {}
                  snackMessage = errorMsg;
                }
              } catch (e) {
                snackMessage = 'Lỗi: $e';
              }
              Navigator.pop(context);
            },
          ),
        ],
      ),
    );
    if (snackMessage != null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(snackMessage!)),
      );
    }
  }

  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();
  bool _isLoading = false;
  bool _obscurePassword = true;

  Future<void> _login() async {
    setState(() {
      _isLoading = true;
    });
    final email = _emailController.text.trim();
    final password = _passwordController.text.trim();
    if (email.isEmpty || password.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
            content: Text('Vui lòng nhập đầy đủ email và mật khẩu!')),
      );
      setState(() {
        _isLoading = false;
      });
      return;
    }
    try {
      final response = await http.post(
        Uri.parse('https://food-app-cweu.onrender.com/api/v1/auth/login'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'email': email, 'password': password}),
      );
      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        debugPrint('Login response: ${response.body}');
        // In ra toàn bộ data để kiểm tra cấu trúc
        debugPrint('Login data: $data');
        var user = data['data'];
        // Thử lấy token từ nhiều trường phổ biến
        String? accessToken = '';
        if (data['accessToken'] != null)
          accessToken = data['accessToken'];
        else if (data['token'] != null)
          accessToken = data['token'];
        else if (user?['accessToken'] != null)
          accessToken = user?['accessToken'];
        else if (user?['token'] != null) accessToken = user?['token'];
        debugPrint('AccessToken to save: $accessToken');
        if (accessToken != null && accessToken.toString().isNotEmpty) {
          final prefs = await SharedPreferences.getInstance();
          await prefs.setString('token', accessToken.toString());
        }
        if (user != null) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Đăng nhập thành công!')),
          );
          await Future.delayed(const Duration(milliseconds: 500));
          // Lấy role từ user object, có thể là 'role', 'userRole', hoặc 'type'
          final role =
              user['role'] ?? user['userRole'] ?? user['type'] ?? 'user';
          // ...existing code...
          // ...existing code...
          if (role == 'admin') {
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(
                builder: (context) => AdminHome(
                  userRole: role,
                  userEmail: user['email'] ?? '',
                ),
              ),
            );
          } else {
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(builder: (context) => const HomeUser()),
            );
          }
// ...existing code...
// ...existing code...
        } else {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
                content: Text('Không tìm thấy thông tin người dùng!')),
          );
        }
      } else {
        String errorMessage = 'Đăng nhập thất bại: ${response.statusCode}';
        try {
          final errorData = jsonDecode(response.body);
          if (errorData['message'] != null) {
            errorMessage = errorData['message'].toString();
          } else if (response.statusCode == 401) {
            errorMessage = 'Sai email hoặc mật khẩu.';
          } else if (response.statusCode == 404) {
            errorMessage = 'Tài khoản không tồn tại hoặc chưa đăng ký.';
          }
        } catch (_) {
          // Nếu không parse được JSON thì giữ nguyên errorMessage
        }
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(errorMessage)),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi: $e')),
      );
    }
    setState(() {
      _isLoading = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    debugPrint(
        'ForgotStep: $_forgotStep, ShowForgotPassword: $_showForgotPassword'); // Thêm dòng này để log trạng thái
    return Scaffold(
      backgroundColor: Colors.white,
      body: SingleChildScrollView(
        padding: const EdgeInsets.symmetric(horizontal: 25, vertical: 60),
        child: !_showForgotPassword
            ? Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  const SizedBox(height: 20),
                  const Text(
                    'Đăng Nhập KFC FOOD',
                    style: TextStyle(
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                      color: Colors.orange,
                    ),
                  ),
                  const SizedBox(height: 40),
                  // Email Field
                  TextField(
                    controller: _emailController,
                    decoration: InputDecoration(
                      labelText: 'Email',
                      prefixIcon: const Icon(Icons.email, color: Colors.orange),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(30),
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Password Field
                  TextField(
                    controller: _passwordController,
                    obscureText: _obscurePassword,
                    decoration: InputDecoration(
                      labelText: 'Mật Khẩu',
                      prefixIcon: const Icon(Icons.lock, color: Colors.orange),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(30),
                      ),
                      suffixIcon: IconButton(
                        icon: Icon(
                          _obscurePassword
                              ? Icons.visibility_off
                              : Icons.visibility,
                          color: Colors.orange,
                        ),
                        onPressed: () {
                          setState(() {
                            _obscurePassword = !_obscurePassword;
                          });
                        },
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Forgot password
                  Align(
                    alignment: Alignment.centerRight,
                    child: TextButton(
                      onPressed: _isLoading
                          ? null
                          : () {
                              setState(() {
                                _showForgotPassword = true;
                                _forgotStep = 0;
                                _forgotEmailController.clear();
                                _resetCodeController.clear();
                                _resetPasswordController.clear();
                                _resetConfirmController.clear();
                              });
                            },
                      child: const Text(
                        'Quên mật khẩu?',
                        style: TextStyle(color: Colors.orange),
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Login Button
                  SizedBox(
                    width: double.infinity,
                    height: 50,
                    child: ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.orange,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(30),
                        ),
                      ),
                      onPressed: _isLoading ? null : _login,
                      child: _isLoading
                          ? const CircularProgressIndicator(color: Colors.white)
                          : const Text(
                              'Đăng Nhập',
                              style:
                                  TextStyle(fontSize: 18, color: Colors.white),
                            ),
                    ),
                  ),
                  const SizedBox(height: 30),
                  // Google Sign In Button
                  SizedBox(
                    width: double.infinity,
                    height: 50,
                    child: ElevatedButton.icon(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.white,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(30),
                          side: const BorderSide(color: Colors.orange),
                        ),
                      ),
                      icon: Image.network(
                        'https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_2013_Google.png',
                        height: 24,
                      ),
                      label: const Text(
                        'Đăng nhập bằng Google',
                        style: TextStyle(
                            color: Colors.orange, fontWeight: FontWeight.bold),
                      ),
                      onPressed: () async {
                        final user = await AuthService().signInWithGoogle();
                        Navigator.pushReplacement(
                          context,
                          MaterialPageRoute(
                              builder: (context) => const HomeUser()),
                        );
                      },
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Sign Up
                  Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Text('Bạn chưa có tài khoản?'),
                      TextButton(
                        onPressed: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                                builder: (context) => const RegisterScreen()),
                          );
                        },
                        child: const Text(
                          'Đăng ký',
                          style: TextStyle(color: Colors.orange),
                        ),
                      ),
                    ],
                  ),
                ],
              )
            : Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  const SizedBox(height: 20),
                  const Text(
                    'Quên mật khẩu',
                    style: TextStyle(
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                      color: Colors.orange,
                    ),
                  ),
                  const SizedBox(height: 30),
                  if (_forgotStep == 0) ...[
                    TextField(
                      controller: _forgotEmailController,
                      decoration: const InputDecoration(
                        labelText: 'Nhập email đã đăng ký',
                        border: OutlineInputBorder(),
                      ),
                      keyboardType: TextInputType.emailAddress,
                    ),
                    const SizedBox(height: 24),
                    SizedBox(
                      width: double.infinity,
                      height: 50,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.orange),
                        child: const Text('Gửi mã xác thực'),
                        onPressed: _sendForgotPasswordEmail,
                      ),
                    ),
                    TextButton(
                      onPressed: () {
                        setState(() {
                          _showForgotPassword = false;
                          _forgotStep = 0;
                        });
                      },
                      child: const Text('Quay lại đăng nhập'),
                    ),
                  ] else if (_forgotStep == 1) ...[
                    Text('Nhập mã xác thực đã gửi về email: $_resetEmail',
                        style: const TextStyle(color: Colors.black87)),
                    const SizedBox(height: 20),
                    TextField(
                      controller: _resetCodeController,
                      decoration: const InputDecoration(
                          labelText: 'Mã xác thực (code)',
                          border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 24),
                    SizedBox(
                      width: double.infinity,
                      height: 50,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.orange),
                        child: const Text('Xác thực mã'),
                        onPressed: _verifyCode,
                      ),
                    ),
                    const SizedBox(height: 12), // Spacing added
                    SizedBox(
                      width: double.infinity,
                      height: 50,
                      child: TextButton(
                        onPressed: () {
                          // Gửi lại mã xác thực về email đã nhập
                          _forgotEmailController.text = _resetEmail;
                          _sendForgotPasswordEmail();
                        },
                        child: const Text('Gửi lại mã',
                            style: TextStyle(color: Colors.orange)),
                      ),
                    ),
                    TextButton(
                      onPressed: () {
                        setState(() {
                          _showForgotPassword = false;
                          _forgotStep = 0;
                        });
                      },
                      child: const Text('Quay lại đăng nhập'),
                    ),
                  ] else if (_forgotStep == 2) ...[
                    Text('Nhập mật khẩu mới cho tài khoản: $_resetEmail',
                        style: const TextStyle(color: Colors.black87)),
                    const SizedBox(height: 20),
                    TextField(
                      controller: _resetPasswordController,
                      obscureText: true,
                      decoration: const InputDecoration(
                          labelText: 'Mật khẩu mới',
                          border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 16),
                    TextField(
                      controller: _resetConfirmController,
                      obscureText: true,
                      decoration: const InputDecoration(
                          labelText: 'Nhập lại mật khẩu mới',
                          border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 24),
                    Row(
                      children: [
                        Expanded(
                          child: ElevatedButton(
                            style: ElevatedButton.styleFrom(
                                backgroundColor: Colors.orange),
                            child: const Text('Đặt lại mật khẩu'),
                            onPressed: _resetPassword,
                          ),
                        ),
                        const SizedBox(width: 16),
                        TextButton(
                          onPressed: () {
                            setState(() {
                              _showForgotPassword = false;
                              _forgotStep = 0;
                            });
                          },
                          child: const Text('Quay lại đăng nhập'),
                        ),
                      ],
                    ),
                  ],
                ],
              ),
      ),
    );
  }
}


---

_**Assistant**_

Code của bạn đã đúng logic chuyển bước nhập mã OTP. Tuy nhiên, **API xác thực mã OTP bạn đang dùng là `/api/v1/auth/verify-reset-code`**, nhưng theo nhiều backend phổ biến, endpoint này thường là `/api/v1/auth/verify` hoặc tương tự.

**Hãy kiểm tra lại endpoint xác thực mã OTP trên backend của bạn. Nếu đúng là `/verify-reset-code` thì không cần đổi, còn nếu không, hãy sửa lại như sau:**

````dart
Future<void> _verifyCode() async {
  final code = _resetCodeController.text.trim();
  if (code.isEmpty) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Vui lòng nhập mã xác thực!')),
    );
    return;
  }
  try {
    final response = await http.post(
      Uri.parse(
          'https://food-app-cweu.onrender.com/api/v1/auth/verify'), // Sửa endpoint nếu cần
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({'email': _resetEmail, 'code': code}),
    );
    if (response.statusCode == 200) {
      setState(() {
        _forgotStep = 2;
      });
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
            content: Text('Mã xác thực đúng. Vui lòng nhập mật khẩu mới!')),
      );
    } else {
      String errorMsg = 'Mã xác thực không đúng!';
      try {
        final err = jsonDecode(response.body);
        if (err is Map && err['message'] != null) {
          errorMsg = err['message'].toString();
        }
      } catch (_) {}
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(errorMsg)),
      );
    }
  } catch (e) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Lỗi: $e')),
    );
  }
}
````

---

**Ngoài ra, để debug tốt hơn, hãy kiểm tra log dòng này trong hàm build:**
```dart
debugPrint('ForgotStep: $_forgotStep, ShowForgotPassword: $_showForgotPassword');
```
- Nếu sau khi nhấn "Gửi mã xác thực", log ra `ForgotStep: 1, ShowForgotPassword: true` mà UI không đổi, hãy thử hot restart app.
- Nếu log không đổi, hãy kiểm tra lại chỗ setState.

---

**Tóm lại:**  
- Kiểm tra lại endpoint xác thực mã OTP.
- Đảm bảo `_forgotStep` được set sang 1 khi gửi mã thành công.
- Nếu vẫn không được, thử hot restart app và kiểm tra log debug.

Nếu vẫn gặp lỗi, hãy gửi log debug sau khi nhấn "Gửi mã xác thực" để mình hỗ trợ tiếp!

---

_**User**_

thêm dòng này ở dâu debugPrint('ForgotStep: $_forgotStep, ShowForgotPassword: $_showForgotPassword');

---

_**Assistant**_

Bạn nên thêm dòng sau vào **đầu hàm build** để mỗi lần UI render sẽ log ra trạng thái forgotStep và showForgotPassword:

````dart
@override
Widget build(BuildContext context) {
  debugPrint('ForgotStep: $_forgotStep, ShowForgotPassword: $_showForgotPassword'); // Thêm ngay sau dòng mở đầu hàm build
  return Scaffold(
    backgroundColor: Colors.white,
    body: SingleChildScrollView(
      // ...existing code...
````

**Vị trí chính xác:**  
Ngay sau dòng `Widget build(BuildContext context) {` và trước `return Scaffold(`.  
Như vậy, mỗi lần UI cập nhật, bạn sẽ thấy log trạng thái này trên debug console.

---

_**User**_

sao vẫn chưa hiện trang nhập mã lm cho tôi trang nhập mã I/ViewRootImpl@9049e52[MainActivity](16093): mWNT: merge t to BBQ
D/InputConnectionAdaptor(16093): The input method toggled text monitoring on
D/InputConnectionAdaptor(16093): The input method toggled text monitoring off
I/ViewRootImpl(16093): updatePointerIcon pointerType = 1000, calling pid = 16093
D/InputManager(16093): setPointerIconType iconId = 1000, callingPid = 16093
I/ViewRootImpl(16093): updatePointerIcon pointerType = 1000, calling pid = 16093
D/InputManager(16093): setPointerIconType iconId = 1000, callingPid = 16093
I/ViewRootImpl(16093): updatePointerIcon pointerType = 1000, calling pid = 16093
D/InputManager(16093): setPointerIconType iconId = 1000, callingPid = 16093
I/ViewRootImpl(16093): updatePointerIcon pointerType = 1000, calling pid = 16093
D/InputManager(16093): setPointerIconType iconId = 1000, callingPid = 16093

---

_**Assistant**_

Bạn đã code đúng logic, nhưng để **chắc chắn luôn hiện trang nhập mã OTP** sau khi nhấn "Gửi mã xác thực", bạn có thể tạo một widget riêng cho bước nhập mã OTP như sau:

Thay thế phần hiển thị forgot password trong hàm `build` bằng đoạn dưới đây để đảm bảo UI luôn hiện đúng bước:

````dart
...
child: !_showForgotPassword
    ? // ...existing code cho đăng nhập...
    : Column(
        crossAxisAlignment: CrossAxisAlignment.center,
        children: [
          const SizedBox(height: 20),
          const Text(
            'Quên mật khẩu',
            style: TextStyle(
              fontSize: 28,
              fontWeight: FontWeight.bold,
              color: Colors.orange,
            ),
          ),
          const SizedBox(height: 30),
          if (_forgotStep == 0) ...[
            TextField(
              controller: _forgotEmailController,
              decoration: const InputDecoration(
                labelText: 'Nhập email đã đăng ký',
                border: OutlineInputBorder(),
              ),
              keyboardType: TextInputType.emailAddress,
            ),
            const SizedBox(height: 24),
            SizedBox(
              width: double.infinity,
              height: 50,
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.orange),
                child: const Text('Gửi mã xác thực'),
                onPressed: _sendForgotPasswordEmail,
              ),
            ),
            TextButton(
              onPressed: () {
                setState(() {
                  _showForgotPassword = false;
                  _forgotStep = 0;
                });
              },
              child: const Text('Quay lại đăng nhập'),
            ),
          ] else if (_forgotStep == 1) ...[
            // TRANG NHẬP MÃ OTP
            Text('Nhập mã xác thực đã gửi về email: $_resetEmail',
                style: const TextStyle(color: Colors.black87)),
            const SizedBox(height: 20),
            TextField(
              controller: _resetCodeController,
              decoration: const InputDecoration(
                  labelText: 'Mã xác thực (code)',
                  border: OutlineInputBorder()),
              keyboardType: TextInputType.number,
            ),
            const SizedBox(height: 24),
            SizedBox(
              width: double.infinity,
              height: 50,
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.orange),
                child: const Text('Xác thực mã'),
                onPressed: _verifyCode,
              ),
            ),
            const SizedBox(height: 12),
            SizedBox(
              width: double.infinity,
              height: 50,
              child: TextButton(
                onPressed: () {
                  _forgotEmailController.text = _resetEmail;
                  _sendForgotPasswordEmail();
                },
                child: const Text('Gửi lại mã',
                    style: TextStyle(color: Colors.orange)),
              ),
            ),
            TextButton(
              onPressed: () {
                setState(() {
                  _showForgotPassword = false;
                  _forgotStep = 0;
                });
              },
              child: const Text('Quay lại đăng nhập'),
            ),
          ] else if (_forgotStep == 2) ...[
            // ...phần nhập mật khẩu mới...
          ],
        ],
      ),
...
````

**Lưu ý:**
- Đảm bảo `_forgotStep` được set về 1 khi gửi mã thành công.
- Nếu vẫn không hiện, hãy thử hot restart app.
- Nếu vẫn lỗi, kiểm tra log debug dòng `ForgotStep: ...` để xác nhận giá trị.

**Với đoạn code trên, UI sẽ luôn hiện trang nhập mã OTP khi `_forgotStep == 1`.**

---

_**User**_

cập nhật cho tôi     const SizedBox(height: 20),
                  // Forgot password
                  Align(
                    alignment: Alignment.centerRight,
                    child: TextButton(
                      onPressed: _isLoading
                          ? null
                          : () {
                              setState(() {
                                _showForgotPassword = true;
                                _forgotStep = 0;
                                _forgotEmailController.clear();
                                _resetCodeController.clear();
                                _resetPasswordController.clear();
                                _resetConfirmController.clear();
                              });
                            },
                      child: const Text(
                        'Quên mật khẩu?',
                        style: TextStyle(color: Colors.orange),
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Login Button
                  SizedBox(
                    width: double.infinity,
                    height: 50,
                    child: ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.orange,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(30),
                        ),
                      ),
                      onPressed: _isLoading ? null : _login,
                      child: _isLoading
                          ? const CircularProgressIndicator(color: Colors.white)
                          : const Text(
                              'Đăng Nhập',
                              style:
                                  TextStyle(fontSize: 18, color: Colors.white),
                            ),
                    ),
                  ),
                  const SizedBox(height: 30),
                  // Google Sign In Button
                  SizedBox(
                    width: double.infinity,
                    height: 50,
                    child: ElevatedButton.icon(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.white,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(30),
                          side: const BorderSide(color: Colors.orange),
                        ),
                      ),
                      icon: Image.network(
                        'https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_2013_Google.png',
                        height: 24,
                      ),
                      label: const Text(
                        'Đăng nhập bằng Google',
                        style: TextStyle(
                            color: Colors.orange, fontWeight: FontWeight.bold),
                      ),
                      onPressed: () async {
                        final user = await AuthService().signInWithGoogle();
                        Navigator.pushReplacement(
                          context,
                          MaterialPageRoute(
                              builder: (context) => const HomeUser()),
                        );
                      },
                    ),
                  ),
                  const SizedBox(height: 20),
                  // Sign Up
                  Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Text('Bạn chưa có tài khoản?'),
                      TextButton(
                        onPressed: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                                builder: (context) => const RegisterScreen()),
                          );
                        },
                        child: const Text(
                          'Đăng ký',
                          style: TextStyle(color: Colors.orange),
                        ),
                      ),
                    ],
                  ),
                ],
              )
            : Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  const SizedBox(height: 20),
                  const Text(
                    'Quên mật khẩu',
                    style: TextStyle(
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                      color: Colors.orange,
                    ),
                  ),
                  const SizedBox(height: 30),
                  if (_forgotStep == 0) ...[
                    TextField(
                      controller: _forgotEmailController,
                      decoration: const InputDecoration(
                        labelText: 'Nhập email đã đăng ký',
                        border: OutlineInputBorder(),
                      ),
                      keyboardType: TextInputType.emailAddress,
                    ),
                    const SizedBox(height: 24),
                    SizedBox(
                      width: double.infinity,
                      height: 50,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.orange),
                        child: const Text('Gửi mã xác thực'),
                        onPressed: _sendForgotPasswordEmail,
                      ),
                    ),
                    TextButton(
                      onPressed: () {
                        setState(() {
                          _showForgotPassword = false;
                          _forgotStep = 0;
                        });
                      },
                      child: const Text('Quay lại đăng nhập'),
                    ),
                  ] else if (_forgotStep == 1) ...[
                    Text('Nhập mã xác thực đã gửi về email: $_resetEmail',
                        style: const TextStyle(color: Colors.black87)),
                    const SizedBox(height: 20),
                    TextField(
                      controller: _resetCodeController,
                      decoration: const InputDecoration(
                          labelText: 'Mã xác thực (code)',
                          border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 24),
                    SizedBox(
                      width: double.infinity,
                      height: 50,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.orange),
                        child: const Text('Xác thực mã'),
                        onPressed: _verifyCode,
                      ),
                    ),
                    const SizedBox(height: 12), // Spacing added
                    SizedBox(
                      width: double.infinity,
                      height: 50,
                      child: TextButton(
                        onPressed: () {
                          // Gửi lại mã xác thực về email đã nhập
                          _forgotEmailController.text = _resetEmail;
                          _sendForgotPasswordEmail();
                        },
                        child: const Text('Gửi lại mã',
                            style: TextStyle(color: Colors.orange)),
                      ),
                    ),
                    TextButton(
                      onPressed: () {
                        setState(() {
                          _showForgotPassword = false;
                          _forgotStep = 0;
                        });
                      },
                      child: const Text('Quay lại đăng nhập'),
                    ),
                  ] else if (_forgotStep == 2) ...[
                    Text('Nhập mật khẩu mới cho tài khoản: $_resetEmail',
                        style: const TextStyle(color: Colors.black87)),
                    const SizedBox(height: 20),
                    TextField(
                      controller: _resetPasswordController,
                      obscureText: true,
                      decoration: const InputDecoration(
                          labelText: 'Mật khẩu mới',
                          border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 16),
                    TextField(
                      controller: _resetConfirmController,
                      obscureText: true,
                      decoration: const InputDecoration(
                          labelText: 'Nhập lại mật khẩu mới',
                          border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 24),
                    Row(
                      children: [
                        Expanded(
                          child: ElevatedButton(
                            style: ElevatedButton.styleFrom(
                                backgroundColor: Colors.orange),
                            child: const Text('Đặt lại mật khẩu'),
                            onPressed: _resetPassword,
                          ),
                        ),
                        const SizedBox(width: 16),
                        TextButton(
                          onPressed: () {
                            setState(() {
                              _showForgotPassword = false;
                              _forgotStep = 0;
                            });
                          },
                          child: const Text('Quay lại đăng nhập'),
                        ),
                      ],
                    ),
                  ],
                ],
              ),
      ),
    );
  }
}


---

_**Assistant**_

Bạn muốn cập nhật lại phần giao diện để **luôn hiển thị trang nhập mã xác thực OTP** khi `_forgotStep == 1`.  
Dưới đây là đoạn code đã được tối ưu lại, đảm bảo UI chuyển đúng bước và rõ ràng từng phần:

````dart
// ...existing code...
const SizedBox(height: 20),
// Forgot password
Align(
  alignment: Alignment.centerRight,
  child: TextButton(
    onPressed: _isLoading
        ? null
        : () {
            setState(() {
              _showForgotPassword = true;
              _forgotStep = 0;
              _forgotEmailController.clear();
              _resetCodeController.clear();
              _resetPasswordController.clear();
              _resetConfirmController.clear();
            });
          },
    child: const Text(
      'Quên mật khẩu?',
      style: TextStyle(color: Colors.orange),
    ),
  ),
),
const SizedBox(height: 20),
// Login Button
SizedBox(
  width: double.infinity,
  height: 50,
  child: ElevatedButton(
    style: ElevatedButton.styleFrom(
      backgroundColor: Colors.orange,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(30),
      ),
    ),
    onPressed: _isLoading ? null : _login,
    child: _isLoading
        ? const CircularProgressIndicator(color: Colors.white)
        : const Text(
            'Đăng Nhập',
            style: TextStyle(fontSize: 18, color: Colors.white),
          ),
  ),
),
const SizedBox(height: 30),
// Google Sign In Button
SizedBox(
  width: double.infinity,
  height: 50,
  child: ElevatedButton.icon(
    style: ElevatedButton.styleFrom(
      backgroundColor: Colors.white,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(30),
        side: const BorderSide(color: Colors.orange),
      ),
    ),
    icon: Image.network(
      'https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_2013_Google.png',
      height: 24,
    ),
    label: const Text(
      'Đăng nhập bằng Google',
      style: TextStyle(
          color: Colors.orange, fontWeight: FontWeight.bold),
    ),
    onPressed: () async {
      final user = await AuthService().signInWithGoogle();
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(
            builder: (context) => const HomeUser()),
      );
    },
  ),
),
const SizedBox(height: 20),
// Sign Up
Row(
  mainAxisAlignment: MainAxisAlignment.center,
  children: [
    const Text('Bạn chưa có tài khoản?'),
    TextButton(
      onPressed: () {
        Navigator.push(
          context,
          MaterialPageRoute(
              builder: (context) => const RegisterScreen()),
        );
      },
      child: const Text(
        'Đăng ký',
        style: TextStyle(color: Colors.orange),
      ),
    ),
  ],
),
// ...existing code...

// Phần forgot password:
: Column(
    crossAxisAlignment: CrossAxisAlignment.center,
    children: [
      const SizedBox(height: 20),
      const Text(
        'Quên mật khẩu',
        style: TextStyle(
          fontSize: 28,
          fontWeight: FontWeight.bold,
          color: Colors.orange,
        ),
      ),
      const SizedBox(height: 30),
      if (_forgotStep == 0) ...[
        TextField(
          controller: _forgotEmailController,
          decoration: const InputDecoration(
            labelText: 'Nhập email đã đăng ký',
            border: OutlineInputBorder(),
          ),
          keyboardType: TextInputType.emailAddress,
        ),
        const SizedBox(height: 24),
        SizedBox(
          width: double.infinity,
          height: 50,
          child: ElevatedButton(
            style: ElevatedButton.styleFrom(
                backgroundColor: Colors.orange),
            child: const Text('Gửi mã xác thực'),
            onPressed: _sendForgotPasswordEmail,
          ),
        ),
        TextButton(
          onPressed: () {
            setState(() {
              _showForgotPassword = false;
              _forgotStep = 0;
            });
          },
          child: const Text('Quay lại đăng nhập'),
        ),
      ] else if (_forgotStep == 1) ...[
        // TRANG NHẬP MÃ OTP
        Text('Nhập mã xác thực đã gửi về email: $_resetEmail',
            style: const TextStyle(color: Colors.black87)),
        const SizedBox(height: 20),
        TextField(
          controller: _resetCodeController,
          decoration: const InputDecoration(
              labelText: 'Mã xác thực (code)',
              border: OutlineInputBorder()),
          keyboardType: TextInputType.number,
        ),
        const SizedBox(height: 24),
        SizedBox(
          width: double.infinity,
          height: 50,
          child: ElevatedButton(
            style: ElevatedButton.styleFrom(
                backgroundColor: Colors.orange),
            child: const Text('Xác thực mã'),
            onPressed: _verifyCode,
          ),
        ),
        const SizedBox(height: 12),
        SizedBox(
          width: double.infinity,
          height: 50,
          child: TextButton(
            onPressed: () {
              _forgotEmailController.text = _resetEmail;
              _sendForgotPasswordEmail();
            },
            child: const Text('Gửi lại mã',
                style: TextStyle(color: Colors.orange)),
          ),
        ),
        TextButton(
          onPressed: () {
            setState(() {
              _showForgotPassword = false;
              _forgotStep = 0;
            });
          },
          child: const Text('Quay lại đăng nhập'),
        ),
      ] else if (_forgotStep == 2) ...[
        Text('Nhập mật khẩu mới cho tài khoản: $_resetEmail',
            style: const TextStyle(color: Colors.black87)),
        const SizedBox(height: 20),
        TextField(
          controller: _resetPasswordController,
          obscureText: true,
          decoration: const InputDecoration(
              labelText: 'Mật khẩu mới',
              border: OutlineInputBorder()),
        ),
        const SizedBox(height: 16),
        TextField(
          controller: _resetConfirmController,
          obscureText: true,
          decoration: const InputDecoration(
              labelText: 'Nhập lại mật khẩu mới',
              border: OutlineInputBorder()),
        ),
        const SizedBox(height: 24),
        Row(
          children: [
            Expanded(
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.orange),
                child: const Text('Đặt lại mật khẩu'),
                onPressed: _resetPassword,
              ),
            ),
            const SizedBox(width: 16),
            TextButton(
              onPressed: () {
                setState(() {
                  _showForgotPassword = false;
                  _forgotStep = 0;
                });
              },
              child: const Text('Quay lại đăng nhập'),
            ),
          ],
        ),
      ],
    ],
  ),
// ...existing code...
````

**Chỉ cần copy và thay thế phần giao diện forgot password như trên, UI sẽ luôn hiện đúng trang nhập mã OTP khi `_forgotStep == 1`.**  
Nếu vẫn không hiện, hãy thử hot restart app.

---

_**User**_

[{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": "missing_identifier",
	"severity": 8,
	"message": "Expected an identifier.",
	"source": "dart",
	"startLineNumber": 530,
	"startColumn": 1,
	"endLineNumber": 530,
	"endColumn": 2,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": "expected_token",
	"severity": 8,
	"message": "Expected to find ')'.",
	"source": "dart",
	"startLineNumber": 530,
	"startColumn": 1,
	"endLineNumber": 530,
	"endColumn": 2,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": "expected_token",
	"severity": 8,
	"message": "Expected to find ']'.",
	"source": "dart",
	"startLineNumber": 530,
	"startColumn": 1,
	"endLineNumber": 530,
	"endColumn": 2,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": "expected_token",
	"severity": 8,
	"message": "Expected to find ':'.",
	"source": "dart",
	"startLineNumber": 663,
	"startColumn": 8,
	"endLineNumber": 663,
	"endColumn": 9,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": "missing_identifier",
	"severity": 8,
	"message": "Expected an identifier.",
	"source": "dart",
	"startLineNumber": 663,
	"startColumn": 8,
	"endLineNumber": 663,
	"endColumn": 9,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": "expected_token",
	"severity": 8,
	"message": "Expected to find ')'.",
	"source": "dart",
	"startLineNumber": 664,
	"startColumn": 6,
	"endLineNumber": 664,
	"endColumn": 7,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "unused_import",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/unused_import",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 4,
	"message": "Unused import: '../admin/quan_ly_thong_ke.dart'.\nTry removing the import directive.",
	"source": "dart",
	"startLineNumber": 10,
	"startColumn": 8,
	"endLineNumber": 10,
	"endColumn": 40,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "unused_field",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/unused_field",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 4,
	"message": "The value of the field '_forgotStep' isn't used.\nTry removing the field, or using it.",
	"source": "dart",
	"startLineNumber": 22,
	"startColumn": 7,
	"endLineNumber": 22,
	"endColumn": 18,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "unused_element",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/unused_element",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 4,
	"message": "The declaration '_sendForgotPasswordEmail' isn't referenced.\nTry removing the declaration of '_sendForgotPasswordEmail'.",
	"source": "dart",
	"startLineNumber": 30,
	"startColumn": 16,
	"endLineNumber": 30,
	"endColumn": 40,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "unused_element",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/unused_element",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 4,
	"message": "The declaration '_verifyCode' isn't referenced.\nTry removing the declaration of '_verifyCode'.",
	"source": "dart",
	"startLineNumber": 74,
	"startColumn": 16,
	"endLineNumber": 74,
	"endColumn": 27,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "unused_element",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/unused_element",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 4,
	"message": "The declaration '_resetPassword' isn't referenced.\nTry removing the declaration of '_resetPassword'.",
	"source": "dart",
	"startLineNumber": 116,
	"startColumn": 16,
	"endLineNumber": 116,
	"endColumn": 30,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "unused_element",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/unused_element",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 4,
	"message": "The declaration '_showResetPasswordDialog' isn't referenced.\nTry removing the declaration of '_showResetPasswordDialog'.",
	"source": "dart",
	"startLineNumber": 169,
	"startColumn": 16,
	"endLineNumber": 169,
	"endColumn": 40,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "unused_local_variable",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/unused_local_variable",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 4,
	"message": "The value of the local variable 'user' isn't used.\nTry removing the variable or using it.",
	"source": "dart",
	"startLineNumber": 497,
	"startColumn": 13,
	"endLineNumber": 497,
	"endColumn": 17,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 50,
	"startColumn": 30,
	"endLineNumber": 50,
	"endColumn": 37,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 63,
	"startColumn": 30,
	"endLineNumber": 63,
	"endColumn": 37,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 68,
	"startColumn": 28,
	"endLineNumber": 68,
	"endColumn": 35,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 93,
	"startColumn": 30,
	"endLineNumber": 93,
	"endColumn": 37,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 105,
	"startColumn": 30,
	"endLineNumber": 105,
	"endColumn": 37,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 110,
	"startColumn": 28,
	"endLineNumber": 110,
	"endColumn": 35,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 143,
	"startColumn": 30,
	"endLineNumber": 143,
	"endColumn": 37,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 158,
	"startColumn": 30,
	"endLineNumber": 158,
	"endColumn": 37,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 163,
	"startColumn": 28,
	"endLineNumber": 163,
	"endColumn": 35,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 250,
	"startColumn": 29,
	"endLineNumber": 250,
	"endColumn": 36,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 257,
	"startColumn": 28,
	"endLineNumber": 257,
	"endColumn": 35,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "curly_braces_in_flow_control_structures",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/curly_braces_in_flow_control_structures",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Statements in an if should be enclosed in a block.\nTry wrapping the statement in a block.",
	"source": "dart",
	"startLineNumber": 299,
	"startColumn": 11,
	"endLineNumber": 299,
	"endColumn": 45,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "curly_braces_in_flow_control_structures",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/curly_braces_in_flow_control_structures",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Statements in an if should be enclosed in a block.\nTry wrapping the statement in a block.",
	"source": "dart",
	"startLineNumber": 301,
	"startColumn": 11,
	"endLineNumber": 301,
	"endColumn": 39,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "curly_braces_in_flow_control_structures",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/curly_braces_in_flow_control_structures",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Statements in an if should be enclosed in a block.\nTry wrapping the statement in a block.",
	"source": "dart",
	"startLineNumber": 303,
	"startColumn": 11,
	"endLineNumber": 303,
	"endColumn": 46,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "curly_braces_in_flow_control_structures",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/curly_braces_in_flow_control_structures",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Statements in an if should be enclosed in a block.\nTry wrapping the statement in a block.",
	"source": "dart",
	"startLineNumber": 304,
	"startColumn": 42,
	"endLineNumber": 304,
	"endColumn": 71,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 311,
	"startColumn": 32,
	"endLineNumber": 311,
	"endColumn": 39,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 322,
	"startColumn": 15,
	"endLineNumber": 322,
	"endColumn": 22,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 332,
	"startColumn": 15,
	"endLineNumber": 332,
	"endColumn": 22,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 339,
	"startColumn": 32,
	"endLineNumber": 339,
	"endColumn": 39,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 358,
	"startColumn": 30,
	"endLineNumber": 358,
	"endColumn": 37,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 363,
	"startColumn": 28,
	"endLineNumber": 363,
	"endColumn": 35,
	"origin": "extHost1"
},{
	"resource": "/d:/LapTrinhAndroid/AndroidOnline/food-app-be/food_app_flutter/lib/Page login/login_screen.dart",
	"owner": "_generated_diagnostic_collection_name_#3",
	"code": {
		"value": "use_build_context_synchronously",
		"target": {
			"$mid": 1,
			"path": "/diagnostics/use_build_context_synchronously",
			"scheme": "https",
			"authority": "dart.dev"
		}
	},
	"severity": 2,
	"message": "Don't use 'BuildContext's across async gaps.\nTry rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check.",
	"source": "dart",
	"startLineNumber": 499,
	"startColumn": 9,
	"endLineNumber": 499,
	"endColumn": 16,
	"origin": "extHost1"
}]

---

_**Assistant**_

Bạn đang gặp lỗi cú pháp ở dòng này:

```dart
// Phần forgot password:
: Column(
```

**Nguyên nhân:**  
Dấu `:` ở đầu dòng là sai cú pháp. Bạn chỉ cần thay bằng toán tử điều kiện ternary (`? :`) hoặc bỏ dấu `:` đi, vì bạn đã dùng điều kiện ở trên với `child: !_showForgotPassword ? ... : ...`.

**Cách sửa:**  
Thay dòng đó và phần forgot password thành như sau:

````dart
// ...existing code...
        child: !_showForgotPassword
            ? Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  // ...phần đăng nhập...
                ],
              )
            : Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  // ...phần forgot password...
                ],
              ),
      ),
    );
  }
}
````

**Tóm lại:**  
- Xóa dòng `: Column(` và thay bằng `? Column(...) : Column(...)` như trên.
- Đảm bảo không có dấu `:` thừa ở đầu dòng.

Sau khi sửa, lỗi cú pháp sẽ hết và giao diện forgot password sẽ hoạt động đúng!

---

