<!-- Generated by SpecStory -->

# HTTP 500 Internal Server Error on Order Confirmation (2025-07-29 17:41Z)

_**User**_

lỗi xác nhận đặt hàng tromg giỏ hàng là sao I/ViewRootImpl@9049e52[MainActivity](21686): mWNT: merge t to BBQ
I/flutter (21686): Sending order data: {"items":[{"quantity":"1","title":"Nấm Kho Tương ","thumbnail":"https://res.cloudinary.com/dukebcqfx/image/upload/v1753600487/bahkt9l9rmbqwrvmadl8.jpg","price":"30000"}],"restaurantId":"67757705-3181-4524-9bc2-2ae994102462","paymentMethod":"cod","status":"pending","address":"alkaal","notes":"slsk","phone":"0963258741","name":"an"}
I/flutter (21686): Response status: 500
I/flutter (21686): Response body: {"statusCode":500,"message":"Internal server error"}
I/flutter (21686): Error details: {statusCode: 500, message: Internal server error} 

---

_**Assistant**_

Lỗi bạn gặp là **HTTP 500 Internal Server Error** khi xác nhận đặt hàng. Điều này nghĩa là server backend đã nhận được request nhưng bị lỗi khi xử lý.

### Nguyên nhân thường gặp:
1. **Dữ liệu gửi lên không đúng định dạng hoặc thiếu trường bắt buộc**  
   (ví dụ: tên trường, kiểu dữ liệu, giá trị null, v.v.)
2. **Server backend có bug hoặc không xử lý được dữ liệu nhận được**
3. **Tham số như `restaurantId` không hợp lệ hoặc không tồn tại**
4. **Các trường như `items`, `paymentMethod`, `status`,... không đúng yêu cầu của API**

---

### Cách kiểm tra & khắc phục:

1. **Kiểm tra lại dữ liệu gửi lên**
   - Bạn đã gửi:
     ```json
     {
       "items": [
         {
           "quantity": "1",
           "title": "Nấm Kho Tương ",
           "thumbnail": "...",
           "price": "30000"
         }
       ],
       "restaurantId": "67757705-3181-4524-9bc2-2ae994102462",
       "paymentMethod": "cod",
       "status": "pending",
       "address": "alkaal",
       "notes": "slsk",
       "phone": "0963258741",
       "name": "an"
     }
     ```
   - **Lưu ý:** `quantity` và `price` đang là **string** (`"1"`, `"30000"`), có thể backend yêu cầu kiểu **số** (int).

2. **Thử đổi kiểu dữ liệu `quantity` và `price` thành số**
   - Sửa đoạn tạo `orderData`:
     ````dart
     // filepath: d:\LapTrinhAndroid\AndroidOnline\food-app-be\food_app_flutter\lib\pages_user\cart_page.dart
     // ...existing code...
     final orderData = {
       'items': cartItems
           .map((item) => {
                 'quantity': item['quantity'], // Để nguyên kiểu int
                 'title': item['name'],
                 'thumbnail': item['thumbnail'],
                 'price': item['price'], // Để nguyên kiểu int
               })
           .toList(),
       // ...existing code...
     };
     // ...existing code...
     ````

3. **Kiểm tra lại `restaurantId` có đúng không**  
   - Đảm bảo ID này tồn tại trên hệ thống backend.

4. **Kiểm tra log backend**  
   - Nếu bạn có quyền truy cập backend, hãy xem log chi tiết để biết lỗi cụ thể.

---

### Tóm lại:
- **Sửa lại kiểu dữ liệu `quantity` và `price` thành số (int) thay vì string.**
- Nếu vẫn lỗi, kiểm tra lại các trường khác và hỏi backend về yêu cầu dữ liệu.

Nếu sau khi sửa kiểu dữ liệu mà vẫn lỗi, hãy gửi thêm log backend hoặc API docs để mình hỗ trợ chi tiết hơn!

---

_**User**_

kiểm tra import 'package:flutter/material.dart';
import 'home.dart'; // Giữ nguyên import
import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';

// ...existing code...

class CartPage extends StatefulWidget {
  final Map<String, dynamic>? food;
  final int? quantity;
  static final List<Map<String, dynamic>> globalCartItems = [];
  const CartPage({Key? key, this.food, this.quantity}) : super(key: key);

  @override
  State<CartPage> createState() => _CartPageState();
}

class _CartPageState extends State<CartPage> {
  final _formKey = GlobalKey<FormState>();
  final TextEditingController _addressController = TextEditingController();
  final TextEditingController _notesController = TextEditingController();
  final TextEditingController _nameController = TextEditingController();
  final TextEditingController _phoneController = TextEditingController();
  List<Map<String, dynamic>> cartItems = [];
  String paymentMethod = 'COD';

  int get totalPrice {
    int sum = 0;
    for (var item in cartItems) {
      sum += ((item['price'] ?? 0) as num).toInt() *
          ((item['quantity'] ?? 1) as int);
    }
    return sum;
  }

  @override
  void initState() {
    super.initState();
    // Nếu có món mới được truyền vào, thêm vào giỏ hàng toàn cục
    if (widget.food != null && widget.quantity != null) {
      CartPage.globalCartItems.add({
        'name': widget.food!['title'] ?? 'Không tên',
        'price': widget.food!['price'] ?? 0,
        'quantity': widget.quantity,
        'thumbnail': widget.food!['thumbnail'],
      });
    }
    cartItems = List<Map<String, dynamic>>.from(CartPage.globalCartItems);
  }

  void removeItem(int index) {
    setState(() {
      CartPage.globalCartItems.removeAt(index);
      cartItems = List<Map<String, dynamic>>.from(CartPage.globalCartItems);
    });
  }

  // Hàm xử lý đặt hàng được giữ nguyên
  Future<void> _placeOrder() async {
    if (cartItems.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Giỏ hàng trống!')),
      );
      return;
    }
    if (_formKey.currentState?.validate() != true) {
      return;
    }

    final prefs = await SharedPreferences.getInstance();
    final token = prefs.getString('token');
    if (token == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Bạn chưa đăng nhập!')),
      );
      return;
    }

    final orderData = {
      'items': cartItems
          .map((item) => {
                'quantity': item['quantity'].toString(),
                'title': item['name'],
                'thumbnail': item['thumbnail'],
                'price': item['price'].toString(),
              })
          .toList(),
      'restaurantId': '67757705-3181-4524-9bc2-2ae994102462',
      'paymentMethod':
          paymentMethod.toLowerCase(), // Sử dụng biến paymentMethod
      'status': 'pending',
      'address': _addressController.text.trim(),
      'notes': _notesController.text.trim().isEmpty
          ? null
          : _notesController.text.trim(),
      'phone': _phoneController.text.trim(),
      'name': _nameController.text.trim(),
    };

    debugPrint('Sending order data: ${jsonEncode(orderData)}');

    try {
      final response = await http.post(
        Uri.parse('https://food-app-cweu.onrender.com/api/v1/orders'),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $token',
        },
        body: jsonEncode(orderData),
      );

      debugPrint('Response status: ${response.statusCode}');
      debugPrint('Response body: ${response.body}');

      if (response.statusCode == 201 || response.statusCode == 200) {
        setState(() {
          CartPage.globalCartItems.clear();
          cartItems.clear();
        });
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Đặt hàng thành công!')),
        );
        Navigator.of(context).pushReplacementNamed('/donhang');
      } else {
        final error = jsonDecode(response.body);
        debugPrint('Error details: $error');
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Đặt hàng thất bại: ${error['message']}')),
        );
      }
    } catch (e) {
      debugPrint('Exception while creating order: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi kết nối: $e')),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Giỏ hàng của bạn',
            style: TextStyle(color: Colors.white)),
        backgroundColor: Colors.orange,
        iconTheme:
            const IconThemeData(color: Colors.white), // Đặt màu icon về trắng
        actions: [
          IconButton(
            icon: const Icon(Icons.shopping_cart),
            tooltip: 'Giỏ hàng',
            onPressed: () {},
          ),
        ],
      ),
      resizeToAvoidBottomInset: true,
      body: cartItems.isEmpty
          ? const Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.remove_shopping_cart,
                      size: 80, color: Colors.grey),
                  SizedBox(height: 16),
                  Text(
                    'Giỏ hàng trống!',
                    style: TextStyle(fontSize: 18, color: Colors.grey),
                  ),
                  Text(
                    'Hãy thêm món ngon vào giỏ của bạn nhé!',
                    style: TextStyle(fontSize: 14, color: Colors.grey),
                  ),
                ],
              ),
            )
          : SingleChildScrollView(
              // Changed: Wrapped with SingleChildScrollView
              child: Form(
                key: _formKey,
                child: Column(
                  children: [
                    // Changed: Integrated cart items directly into the Column
                    ...cartItems.asMap().entries.map((entry) {
                      final int index = entry.key;
                      final Map<String, dynamic> item = entry.value;
                      return Card(
                        margin: const EdgeInsets.symmetric(
                            horizontal: 16, vertical: 8),
                        elevation: 4, // Thêm đổ bóng
                        shape: RoundedRectangleBorder(
                          borderRadius:
                              BorderRadius.circular(12), // Bo góc mềm mại
                        ),
                        child: Padding(
                          padding: const EdgeInsets.all(12.0),
                          child: Row(
                            children: [
                              ClipRRect(
                                borderRadius: BorderRadius.circular(8.0),
                                child: item['thumbnail'] != null &&
                                        item['thumbnail'].isNotEmpty
                                    ? Image.network(
                                        item['thumbnail'],
                                        width: 80,
                                        height: 80,
                                        fit: BoxFit.cover,
                                        errorBuilder:
                                            (context, error, stackTrace) =>
                                                Container(
                                          width: 80,
                                          height: 80,
                                          color: Colors.orange[50],
                                          child: const Icon(Icons.fastfood,
                                              color: Colors.orange, size: 40),
                                        ),
                                      )
                                    : Container(
                                        width: 80,
                                        height: 80,
                                        color: Colors.orange[50],
                                        child: const Icon(Icons.fastfood,
                                            color: Colors.orange, size: 40),
                                      ),
                              ),
                              const SizedBox(width: 16),
                              Expanded(
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      item['name'],
                                      style: const TextStyle(
                                          fontSize: 16,
                                          fontWeight: FontWeight.bold),
                                      maxLines: 2,
                                      overflow: TextOverflow.ellipsis,
                                    ),
                                    const SizedBox(height: 4),
                                    Text(
                                      '${item['price']}đ',
                                      style: TextStyle(
                                          fontSize: 15,
                                          color: Colors.grey[700]),
                                    ),
                                    const SizedBox(height: 8),
                                    Row(
                                      mainAxisAlignment:
                                          MainAxisAlignment.spaceBetween,
                                      children: [
                                        Row(
                                          children: [
                                            _buildQuantityButton(
                                                Icons.remove_circle_outline,
                                                () {
                                              setState(() {
                                                if (item['quantity'] > 1) {
                                                  item['quantity']--;
                                                  CartPage.globalCartItems[
                                                          index]['quantity'] =
                                                      item['quantity'];
                                                }
                                              });
                                            }),
                                            Padding(
                                              padding:
                                                  const EdgeInsets.symmetric(
                                                      horizontal: 8.0),
                                              child: Text(
                                                '${item['quantity']}',
                                                style: const TextStyle(
                                                    fontSize: 16,
                                                    fontWeight:
                                                        FontWeight.bold),
                                              ),
                                            ),
                                            _buildQuantityButton(
                                                Icons.add_circle_outline, () {
                                              setState(() {
                                                item['quantity']++;
                                                CartPage.globalCartItems[index]
                                                        ['quantity'] =
                                                    item['quantity'];
                                              });
                                            }),
                                          ],
                                        ),
                                        IconButton(
                                          icon: const Icon(Icons.delete,
                                              color: Colors.red, size: 24),
                                          onPressed: () => removeItem(index),
                                          tooltip: 'Xóa món ăn',
                                        ),
                                      ],
                                    ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ),
                      );
                    }).toList(),
                    _buildOrderSummary(),
                  ],
                ),
              ),
            ),
      // bottomNavigationBar: null, // Có thể bỏ nếu không cần thiết
    );
  }

  Widget _buildQuantityButton(IconData icon, VoidCallback onPressed) {
    return Container(
      decoration: BoxDecoration(
        color: Colors.orange[100],
        borderRadius: BorderRadius.circular(20),
      ),
      child: IconButton(
        icon: Icon(icon, color: Colors.orange),
        onPressed: onPressed,
        constraints: const BoxConstraints(), // Để icon không bị giãn quá mức
        padding: EdgeInsets.zero,
      ),
    );
  }

  Widget _buildOrderSummary() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        boxShadow: [
          BoxShadow(
            color: Colors.grey.withOpacity(0.2),
            spreadRadius: 2,
            blurRadius: 5,
            offset: const Offset(0, -3), // Shadows on top
          ),
        ],
        borderRadius: const BorderRadius.only(
          topLeft: Radius.circular(20),
          topRight: Radius.circular(20),
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text(
                'Tổng cộng:',
                style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: Colors.black87),
              ),
              Text(
                '${totalPrice}đ',
                style: const TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: Colors.red),
              ),
            ],
          ),
          const Divider(height: 24, thickness: 1), // Đường kẻ phân cách
          Text(
            'Phương thức thanh toán:',
            style:
                TextStyle(fontWeight: FontWeight.bold, color: Colors.grey[700]),
          ),
          Row(
            children: [
              Expanded(
                child: RadioListTile<String>(
                  title: const Text('COD (Thanh toán khi nhận hàng)'),
                  value: 'COD',
                  groupValue: paymentMethod,
                  onChanged: (value) {
                    setState(() {
                      paymentMethod = value!;
                    });
                  },
                  activeColor: Colors.orange,
                  contentPadding: EdgeInsets.zero,
                ),
              ),
              Expanded(
                child: RadioListTile<String>(
                  title: const Text('Chuyển khoản'),
                  value: 'Bank',
                  groupValue: paymentMethod,
                  onChanged: (value) {
                    setState(() {
                      paymentMethod = value!;
                    });
                  },
                  activeColor: Colors.orange,
                  contentPadding: EdgeInsets.zero,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          _buildTextFormField(_nameController, 'Tên người nhận',
              validator: (value) => value == null || value.isEmpty
                  ? 'Vui lòng nhập tên người nhận'
                  : null),
          _buildTextFormField(_phoneController, 'Số điện thoại',
              keyboardType: TextInputType.phone,
              validator: (value) => value == null || value.isEmpty
                  ? 'Vui lòng nhập số điện thoại'
                  : null),
          _buildTextFormField(_addressController, 'Địa chỉ giao hàng',
              validator: (value) => value == null || value.isEmpty
                  ? 'Vui lòng nhập địa chỉ giao hàng'
                  : null),
          _buildTextFormField(_notesController, 'Ghi chú (tuỳ chọn)',
              maxLines: 2),
          const SizedBox(height: 16),
          SizedBox(
            width: double.infinity,
            child: ElevatedButton.icon(
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.orange,
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(vertical: 12),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(10),
                ),
                elevation: 3,
              ),
              onPressed: _placeOrder, // Gọi hàm đặt hàng
              icon: const Icon(Icons.check_circle_outline),
              label: const Text(
                'Xác nhận đặt hàng',
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildTextFormField(TextEditingController controller, String labelText,
      {TextInputType? keyboardType,
      String? Function(String?)? validator,
      int maxLines = 1}) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8.0),
      child: TextFormField(
        controller: controller,
        decoration: InputDecoration(
          labelText: labelText,
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: BorderSide(color: Colors.grey.shade400),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: const BorderSide(color: Colors.orange, width: 2),
          ),
          contentPadding:
              const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          filled: true,
          fillColor: Colors.grey[50],
        ),
        keyboardType: keyboardType,
        validator: validator,
        maxLines: maxLines,
      ),
    );
  }
}

// ---

class OrderPage extends StatefulWidget {
  final String paymentMethod;
  final List<Map<String, dynamic>>? initialOrders;
  const OrderPage({super.key, this.paymentMethod = 'COD', this.initialOrders});

  @override
  State<OrderPage> createState() => _OrderPageState();
}

class _OrderPageState extends State<OrderPage> {
  late List<Map<String, dynamic>> orders;

  final Map<String, String> statusMap = {
    'pending': 'Chờ xác nhận',
    'confirmed': 'Đã xác nhận',
    'delivering': 'Đang giao',
    'delivered': 'Đã giao',
    'cancelled': 'Đã hủy',
  };

  @override
  void initState() {
    super.initState();
    orders = widget.initialOrders ?? [];
    // Tải các đơn hàng từ API khi trang được khởi tạo
    _fetchOrders();
  }

  Future<void> _fetchOrders() async {
    final prefs = await SharedPreferences.getInstance();
    final token = prefs.getString('token');

    if (token == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Bạn chưa đăng nhập!')),
      );
      return;
    }

    try {
      final response = await http.get(
        Uri.parse('https://food-app-cweu.onrender.com/api/v1/orders/my-orders'),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $token',
        },
      );

      if (response.statusCode == 200) {
        final List<dynamic> fetchedOrders = jsonDecode(response.body)['data'];
        setState(() {
          orders = fetchedOrders
              .map((order) => order as Map<String, dynamic>)
              .toList();
        });
      } else {
        debugPrint('Failed to load orders: ${response.body}');
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Không thể tải đơn hàng.')),
        );
      }
    } catch (e) {
      debugPrint('Error fetching orders: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi kết nối khi tải đơn hàng: $e')),
      );
    }
  }

  Color _getStatusColor(String status) {
    switch (status) {
      case 'pending':
        return Colors.orange;
      case 'confirmed':
        return Colors.blue;
      case 'delivering':
        return Colors.purple;
      case 'delivered':
        return Colors.green;
      case 'cancelled':
        return Colors.red;
      default:
        return Colors.grey;
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Đơn hàng của tôi',
            style: TextStyle(color: Colors.white)),
        backgroundColor: Colors.orange,
        iconTheme: const IconThemeData(color: Colors.white),
        actions: [
          IconButton(
            icon: const Icon(Icons.shopping_cart),
            tooltip: 'Giỏ hàng',
            onPressed: () {
              Navigator.of(context).push(
                MaterialPageRoute(builder: (context) => const CartPage()),
              );
            },
          ),
        ],
      ),
      body: orders.isEmpty
          ? Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.receipt_long, size: 80, color: Colors.grey),
                  SizedBox(height: 16),
                  Text(
                    'Bạn chưa có đơn hàng nào.',
                    style: TextStyle(fontSize: 18, color: Colors.grey),
                  ),
                  SizedBox(height: 8),
                  Text(
                    'Hãy bắt đầu đặt món ngay bây giờ!',
                    style: TextStyle(fontSize: 14, color: Colors.grey),
                  ),
                  SizedBox(height: 24),
                  ElevatedButton.icon(
                    onPressed: () {
                      Navigator.of(context).popUntil((route) => route.isFirst);
                      // Chắc chắn Home.dart là route đầu tiên, hoặc điều hướng đến trang chính
                      Navigator.of(context).pushReplacement(
                        MaterialPageRoute(
                            builder: (context) =>
                                const TrangHome()), // Thay thế bằng trang chủ của bạn nếu cần
                      );
                    },
                    icon: const Icon(Icons.restaurant_menu),
                    label: const Text('Xem thực đơn'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.orange,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(
                          horizontal: 20, vertical: 12),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(10),
                      ),
                    ),
                  ),
                ],
              ),
            )
          : ListView.builder(
              padding: const EdgeInsets.symmetric(vertical: 8.0),
              itemCount: orders.length,
              itemBuilder: (context, index) {
                final order = orders[index];
                final String currentStatusDisplay =
                    statusMap[order['status']] ?? 'Không xác định';

                return Card(
                  margin:
                      const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                  elevation: 5,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(15),
                  ),
                  child: Padding(
                    padding: const EdgeInsets.all(16.0),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'Mã đơn hàng: ${order['_id'] ?? 'N/A'}', // Sử dụng _id nếu có
                          style: const TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                              color: Colors.black87),
                        ),
                        const SizedBox(height: 8),
                        Text(
                          'Tổng tiền: ${order['totalPrice'] != null ? order['totalPrice'] : order['total']}đ',
                          style: const TextStyle(
                              fontSize: 15,
                              color: Colors.red,
                              fontWeight: FontWeight.bold),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          'Phương thức thanh toán: ${order['paymentMethod'] == 'cod' ? 'COD (Thanh toán khi nhận hàng)' : 'Chuyển khoản'}',
                          style:
                              TextStyle(fontSize: 14, color: Colors.grey[700]),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          'Địa chỉ: ${order['address'] ?? 'N/A'}',
                          style:
                              TextStyle(fontSize: 14, color: Colors.grey[700]),
                        ),
                        if (order['notes'] != null && order['notes'].isNotEmpty)
                          Padding(
                            padding: const EdgeInsets.only(top: 4.0),
                            child: Text(
                              'Ghi chú: ${order['notes']}',
                              style: TextStyle(
                                  fontSize: 14, color: Colors.grey[700]),
                            ),
                          ),
                        const SizedBox(height: 8),
                        Row(
                          children: [
                            Text(
                              'Trạng thái: ',
                              style: TextStyle(
                                  fontSize: 14, color: Colors.grey[700]),
                            ),
                            Container(
                              padding: const EdgeInsets.symmetric(
                                  horizontal: 8, vertical: 4),
                              decoration: BoxDecoration(
                                color: _getStatusColor(
                                        order['status'] ?? 'unknown')
                                    .withOpacity(0.1),
                                borderRadius: BorderRadius.circular(20),
                              ),
                              child: Text(
                                currentStatusDisplay,
                                style: TextStyle(
                                  color: _getStatusColor(
                                      order['status'] ?? 'unknown'),
                                  fontWeight: FontWeight.bold,
                                  fontSize: 14,
                                ),
                              ),
                            ),
                          ],
                        ),
                        const Divider(height: 20, thickness: 1),
                        const Text(
                          'Chi tiết món ăn:',
                          style: TextStyle(
                              fontSize: 15, fontWeight: FontWeight.bold),
                        ),
                        const SizedBox(height: 8),
                        ListView.builder(
                          shrinkWrap:
                              true, // Quan trọng để ListView.builder lồng nhau
                          physics:
                              const NeverScrollableScrollPhysics(), // Vô hiệu hóa cuộn của ListView con
                          itemCount: (order['items'] as List).length,
                          itemBuilder: (context, itemIndex) {
                            final foodItem =
                                (order['items'] as List)[itemIndex];
                            return Padding(
                              padding:
                                  const EdgeInsets.symmetric(vertical: 4.0),
                              child: Row(
                                children: [
                                  ClipRRect(
                                    borderRadius: BorderRadius.circular(4.0),
                                    child: foodItem['thumbnail'] != null &&
                                            foodItem['thumbnail'].isNotEmpty
                                        ? Image.network(
                                            foodItem['thumbnail'],
                                            width: 50,
                                            height: 50,
                                            fit: BoxFit.cover,
                                            errorBuilder:
                                                (context, error, stackTrace) =>
                                                    Container(
                                              width: 50,
                                              height: 50,
                                              color: Colors.grey[200],
                                              child: const Icon(
                                                  Icons.image_not_supported,
                                                  size: 25),
                                            ),
                                          )
                                        : Container(
                                            width: 50,
                                            height: 50,
                                            color: Colors.grey[200],
                                            child: const Icon(
                                                Icons.image_not_supported,
                                                size: 25),
                                          ),
                                  ),
                                  const SizedBox(width: 12),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        Text(
                                          '${foodItem['title'] ?? 'N/A'}',
                                          style: const TextStyle(
                                              fontWeight: FontWeight.w500),
                                        ),
                                        Text(
                                          '${foodItem['quantity'] ?? 1} x ${foodItem['price'] ?? 0}đ',
                                          style: TextStyle(
                                              color: Colors.grey[600]),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                            );
                          },
                        ),
                      ],
                    ),
                  ),
                );
              },
            ),
    );
  }
}


---

_**Assistant**_

Các import của bạn hoàn toàn **đúng và hợp lệ** cho file này:

```dart
import 'package:flutter/material.dart';
import 'home.dart'; // Giữ nguyên import
import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';
```

- `flutter/material.dart`: UI Flutter.
- `home.dart`: Trang chủ (file local).
- `dart:convert`: Xử lý JSON.
- `http`: Gửi request HTTP.
- `shared_preferences`: Lưu và lấy token đăng nhập.

**Không có lỗi import**. Nếu gặp lỗi khi chạy, nguyên nhân không phải do phần import này.  
Nếu bạn cần kiểm tra import của file khác hoặc muốn tối ưu import, hãy cung cấp thêm thông tin!

---

_**User**_

I/flutter (21686): Sending order data: {"items":[{"quantity":"1","title":"Nấm Kho Tương ","thumbnail":"https://res.cloudinary.com/dukebcqfx/image/upload/v1753600487/bahkt9l9rmbqwrvmadl8.jpg","price":"30000"}],"restaurantId":"67757705-3181-4524-9bc2-2ae994102462","paymentMethod":"cod","status":"pending","address":"alkaal","notes":"slsk","phone":"0963258741","name":"an"}
I/flutter (21686): Response status: 500
I/flutter (21686): Response body: {"statusCode":500,"message":"Internal server error"}
I/flutter (21686): Error details: {statusCode: 500, message: Internal server error}  

---

_**Assistant**_

Bạn đang gửi `"quantity"` và `"price"` dưới dạng **string** (`"1"`, `"30000"`), trong khi backend thường yêu cầu **kiểu số** (`int`). Đây là nguyên nhân phổ biến gây lỗi 500 khi đặt hàng.

**Cách sửa:**  
Gửi `quantity` và `price` là **int** thay vì string.

Hãy sửa đoạn tạo `orderData` như sau:

````dart
// ...existing code...
final orderData = {
  'items': cartItems
      .map((item) => {
            'quantity': item['quantity'], // Để nguyên kiểu int
            'title': item['name'],
            'thumbnail': item['thumbnail'],
            'price': item['price'], // Để nguyên kiểu int
          })
      .toList(),
  'restaurantId': '67757705-3181-4524-9bc2-2ae994102462',
  'paymentMethod': paymentMethod.toLowerCase(),
  'status': 'pending',
  'address': _addressController.text.trim(),
  'notes': _notesController.text.trim().isEmpty
      ? null
      : _notesController.text.trim(),
  'phone': _phoneController.text.trim(),
  'name': _nameController.text.trim(),
};
// ...existing code...
````

**Sau khi sửa, dữ liệu gửi lên sẽ như sau:**
```json
{
  "items": [
    {
      "quantity": 1,
      "title": "Nấm Kho Tương ",
      "thumbnail": "...",
      "price": 30000
    }
  ],
  ...
}
```

**Lưu ý:**  
- Đảm bảo các trường khác đúng yêu cầu backend.
- Nếu vẫn lỗi, kiểm tra log backend hoặc hỏi backend về định dạng dữ liệu.

Sau khi sửa, thử lại đặt hàng. Nếu vẫn lỗi, gửi thêm thông báo lỗi mới để mình hỗ trợ tiếp!

---

_**User**_

I/ViewRootImpl@9049e52[MainActivity](24157): mWNT: merge t to BBQ
I/flutter (24157): Sending order data: {"items":[{"quantity":1,"title":"Đậu hủ kho","thumbnail":"https://res.cloudinary.com/dukebcqfx/image/upload/v1753599727/zw3xexi1lpuwe7rdcxc0.jpg","price":20000}],"restaurantId":"67757705-3181-4524-9bc2-2ae994102462","paymentMethod":"cod","status":"pending","address":"kja","notes":"ksks","phone":"0963225544","name":"an"}
I/flutter (24157): Response status: 500
I/flutter (24157): Response body: {"statusCode":500,"message":"Internal server error"}
I/flutter (24157): Error details: {statusCode: 500, message: Internal server error} 

---

_**Assistant**_

Bạn đã gửi đúng kiểu dữ liệu (`quantity` và `price` là số), nhưng vẫn nhận lỗi **500 Internal server error** từ backend. Điều này cho thấy lỗi nằm ở phía server hoặc dữ liệu gửi lên chưa đúng với yêu cầu backend.

**Các bước kiểm tra tiếp theo:**

1. **Kiểm tra tên trường `title`**  
   Có thể backend yêu cầu trường này là `name` thay vì `title`.  
   → Hãy thử đổi `title` thành `name` trong từng item của `items`.

2. **Kiểm tra các trường bắt buộc khác**  
   Đảm bảo không có trường nào bị thiếu hoặc sai tên.

---

### Sửa code gửi order:

````dart
final orderData = {
  'items': cartItems
      .map((item) => {
            'name': item['name'], // Đổi 'title' thành 'name'
            'quantity': item['quantity'],
            'thumbnail': item['thumbnail'],
            'price': item['price'],
          })
      .toList(),
  'restaurantId': '67757705-3181-4524-9bc2-2ae994102462',
  'paymentMethod': paymentMethod.toLowerCase(),
  'status': 'pending',
  'address': _addressController.text.trim(),
  'notes': _notesController.text.trim().isEmpty
      ? null
      : _notesController.text.trim(),
  'phone': _phoneController.text.trim(),
  'name': _nameController.text.trim(),
};
````

---

**Sau khi sửa, thử lại đặt hàng. Nếu vẫn lỗi:**
- Kiểm tra log backend để biết chi tiết lỗi.
- Đảm bảo `restaurantId` hợp lệ và tồn tại.
- Nếu có tài liệu API, kiểm tra lại định dạng dữ liệu yêu cầu.

Nếu vẫn gặp lỗi, hãy gửi thêm thông tin về API backend hoặc log chi tiết hơn để mình hỗ trợ tiếp!

---

_**User**_

vẫn lỗi I/ViewRootImpl@9049e52[MainActivity](25941): mWNT: merge t to BBQ
I/flutter (25941): Sending order data: {"items":[{"name":"Nấm Kho Tương ","quantity":1,"thumbnail":"https://res.cloudinary.com/dukebcqfx/image/upload/v1753600487/bahkt9l9rmbqwrvmadl8.jpg","price":30000}],"restaurantId":"67757705-3181-4524-9bc2-2ae994102462","paymentMethod":"cod","status":"pending","address":"kske","notes":"kskss","phone":"0963254178","name":"an"}
D/InputTransport(25941): Input channel destroyed: 'ClientS', fd=124
D/InputTransport(25941): Input channel destroyed: 'ClientS', fd=117
D/InputTransport(25941): Input channel destroyed: 'ClientS', fd=112
D/InputTransport(25941): Input channel destroyed: 'ClientS', fd=149
D/InputTransport(25941): Input channel destroyed: 'ClientS', fd=158
D/InputTransport(25941): Input channel destroyed: 'ClientS', fd=139
I/flutter (25941): Response status: 500
I/flutter (25941): Response body: {"statusCode":500,"message":"Internal server error"}
I/flutter (25941): Error details: {statusCode: 500, message: Internal server error} 

---

_**Assistant**_

Bạn đã gửi đúng định dạng dữ liệu, nhưng vẫn bị lỗi **500 Internal Server Error**. Điều này cho thấy backend không xử lý được request, có thể do một trong các nguyên nhân sau:

---

### 1. **Sai tên trường trong `items`**
- Ở phần gửi lên bạn dùng `"name"`, nhưng ở phần hiển thị đơn hàng (`OrderPage`) lại lấy `foodItem['title']`.
- Có thể backend yêu cầu trường là `"title"` chứ không phải `"name"`.

**→ Hãy thử đổi lại thành `"title"` trong từng item khi gửi lên:**

````dart
final orderData = {
  'items': cartItems
      .map((item) => {
            'title': item['name'], // Đổi lại thành 'title'
            'quantity': item['quantity'],
            'thumbnail': item['thumbnail'],
            'price': item['price'],
          })
      .toList(),
  'restaurantId': '67757705-3181-4524-9bc2-2ae994102462',
  'paymentMethod': paymentMethod.toLowerCase(),
  'status': 'pending',
  'address': _addressController.text.trim(),
  'notes': _notesController.text.trim().isEmpty
      ? null
      : _notesController.text.trim(),
  'phone': _phoneController.text.trim(),
  'name': _nameController.text.trim(),
};
````

---

### 2. **Kiểm tra lại các trường khác**
- Đảm bảo không có trường nào bị null hoặc thiếu.
- Đảm bảo `restaurantId` hợp lệ và tồn tại trên hệ thống backend.

---

### 3. **Kiểm tra API Backend**
- Nếu có tài liệu API, kiểm tra lại định dạng từng trường.
- Nếu có thể, kiểm tra log backend để biết lỗi cụ thể.

---

### 4. **Kiểm tra trường `notes`**
- Nếu không có ghi chú, bạn có thể bỏ trường này đi thay vì gửi `null`.

---

**Tóm lại:**  
Hãy đổi lại trường `"name"` thành `"title"` trong từng item của `items` khi gửi lên. Đây là nguyên nhân phổ biến nhất khi backend yêu cầu đúng tên trường.

Sau khi sửa, thử lại đặt hàng. Nếu vẫn lỗi, bạn cần kiểm tra log backend hoặc liên hệ người quản lý backend để biết chi tiết lỗi.

---

_**User**_

1 số đơn hàng khi gửi lên có dạng {
  "message": "success",
  "statusCode": 200,
  "data": [
    {
      "id": "b36cd945-ac33-4ca7-9381-76326adc55df",
      "status": "pending",
      "address": "abc nguyễn đình chiểu",
      "user": {
        "id": "67757705-3181-4524-9bc2-2ae994102462",
        "fullName": "Trần Trung Trực",
        "avatar": null,
        "phone": "0862048408",
        "status": "active",
        "email": "hs236@gmail.com",
        "gender": "male",
        "createdAt": "2025-07-01T11:26:08.000Z",
        "updatedAt": "2025-07-01T11:26:08.000Z"
      },
      "notes": "Thêm ít nước mắm",
      "items": [
        {
          "quantity": "7",
          "title": "Gà rán",
          "thumbnail": "https://cokhiviendong.com/wp-content/uploads/2019/01/kinnh-nghi%E1%BB%87m-m%E1%BB%9F-qu%C3%A1n-g%C3%A0-r%C3%A1n-7.jpg",
          "price": "100000"
        },
        {
          "quantity": "5",
          "title": "Hamburger",
          "thumbnail": "https://thitbonhat.vn/wp-content/uploads/2023/10/banh-hamburger.jpg",
          "price": "100000"
        }
      ],
      "createdAt": "2025-07-29T10:24:15.000Z",
      "updatedAt": "2025-07-29T10:24:15.000Z"
    },
    {
      "id": "669343f8-876a-4fe0-a418-bedc5e57fc51",
      "status": "pending",
      "address": "abc nguyễn đình chiểu",
      "user": {
        "id": "67757705-3181-4524-9bc2-2ae994102462",
        "fullName": "Trần Trung Trực",
        "avatar": null,
        "phone": "0862048408",
        "status": "active",
        "email": "hs236@gmail.com",
        "gender": "male",
        "createdAt": "2025-07-01T11:26:08.000Z",
        "updatedAt": "2025-07-01T11:26:08.000Z"
      },
      "notes": "Thêm ít nước mắm",
      "items": [
        {
          "quantity": "7",
          "title": "Gà rán",
          "thumbnail": "https://cokhiviendong.com/wp-content/uploads/2019/01/kinnh-nghi%E1%BB%87m-m%E1%BB%9F-qu%C3%A1n-g%C3%A0-r%C3%A1n-7.jpg",
          "price": "100000"
        },
        {
          "quantity": "5",
          "title": "Hamburger",
          "thumbnail": "https://thitbonhat.vn/wp-content/uploads/2023/10/banh-hamburger.jpg",
          "price": "100000"
        }
      ],
      "createdAt": "2025-07-26T08:28:05.000Z",
      "updatedAt": "2025-07-26T08:28:05.000Z"
    },
    {
      "id": "b9ce77ba-e9e7-4ab5-915d-4f12fdd4d85e",
      "status": "preparing",
      "address": "abc nguyễn đình chiểu",
      "user": {
        "id": "67757705-3181-4524-9bc2-2ae994102462",
        "fullName": "Trần Trung Trực",
        "avatar": null,
        "phone": "0862048408",
        "status": "active",
        "email": "hs236@gmail.com",
        "gender": "male",
        "createdAt": "2025-07-01T11:26:08.000Z",
        "updatedAt": "2025-07-01T11:26:08.000Z"
      },
      "notes": "Thêm ít nước mắm",
      "items": [
        {
          "quantity": "7",
          "title": "Gà rán",
          "thumbnail": "https://cokhiviendong.com/wp-content/uploads/2019/01/kinnh-nghi%E1%BB%87m-m%E1%BB%9F-qu%C3%A1n-g%C3%A0-r%C3%A1n-7.jpg",
          "price": "100000"
        },
        {
          "quantity": "5",
          "title": "Hamburger",
          "thumbnail": "https://thitbonhat.vn/wp-content/uploads/2023/10/banh-hamburger.jpg",
          "price": "100000"
        }
      ],
      "createdAt": "2025-07-24T10:21:55.000Z",
      "updatedAt": "2025-07-26T03:22:52.000Z"
    },
    {
      "id": "75d28ac1-c75e-4548-a65d-d5aa3a9c0e07",
      "status": "pending",
      "address": "abc nguyễn đình chiểu",
      "user": {
        "id": "67757705-3181-4524-9bc2-2ae994102462",
        "fullName": "Trần Trung Trực",
        "avatar": null,
        "phone": "0862048408",
        "status": "active",
        "email": "hs236@gmail.com",
        "gender": "male",
        "createdAt": "2025-07-01T11:26:08.000Z",
        "updatedAt": "2025-07-01T11:26:08.000Z"
      },
      "notes": null,
      "items": [],
      "createdAt": "2025-07-24T09:34:32.000Z",
      "updatedAt": "2025-07-24T09:34:32.000Z"
    },
    {
      "id": "4ee2a939-695d-446d-9d15-95124928031b",
      "status": "pending",
      "address": "abc nguyễn đình chiểu",
      "user": {
        "id": "67757705-3181-4524-9bc2-2ae994102462",
        "fullName": "Trần Trung Trực",
        "avatar": null,
        "phone": "0862048408",
        "status": "active",
        "email": "hs236@gmail.com",
        "gender": "male",
        "createdAt": "2025-07-01T11:26:08.000Z",
        "updatedAt": "2025-07-01T11:26:08.000Z"
      },
      "notes": null,
      "items": [],
      "createdAt": "2025-07-24T09:11:54.000Z",
      "updatedAt": "2025-07-24T09:11:54.000Z"
    }
  ]
}

---

_**Assistant**_

Bạn đã phát hiện ra rằng **dữ liệu đơn hàng trả về từ backend** có các trường `"quantity"`, `"title"`, `"thumbnail"`, `"price"` đều là **string** (ví dụ `"quantity": "7"`, `"price": "100000"`), **không phải số**. Ngoài ra, trường trong `items` là `"title"`, không phải `"name"`.

**=> Backend yêu cầu:**
- Trường trong `items` phải là `"title"`, không phải `"name"`.
- `"quantity"` và `"price"` nên là **string** (hoặc backend sẽ tự convert, nhưng để chắc chắn, bạn nên gửi đúng kiểu string).

---

## Cách sửa code gửi order:

````dart
final orderData = {
  'items': cartItems
      .map((item) => {
            'title': item['name'], // Đúng tên trường backend yêu cầu
            'quantity': item['quantity'].toString(), // Đúng kiểu string
            'thumbnail': item['thumbnail'],
            'price': item['price'].toString(), // Đúng kiểu string
          })
      .toList(),
  'restaurantId': '67757705-3181-4524-9bc2-2ae994102462',
  'paymentMethod': paymentMethod.toLowerCase(),
  'status': 'pending',
  'address': _addressController.text.trim(),
  'notes': _notesController.text.trim().isEmpty
      ? null
      : _notesController.text.trim(),
  'phone': _phoneController.text.trim(),
  'name': _nameController.text.trim(),
};
````

**Tóm lại:**  
- Đổi `'name'` thành `'title'`  
- Đổi `quantity` và `price` thành string khi gửi lên

---

### Sau khi sửa, thử lại đặt hàng.  
Nếu vẫn lỗi, hãy kiểm tra log backend hoặc hỏi backend về định dạng dữ liệu bắt buộc. Nhưng với dữ liệu mẫu bạn gửi, sửa như trên sẽ đúng chuẩn backend đang trả về!

---

_**User**_

I/ViewRootImpl@9049e52[MainActivity](27690): mWNT: merge t to BBQ
I/flutter (27690): Sending order data: {"items":[{"title":"Nấm Kho Tương ","quantity":"1","thumbnail":"https://res.cloudinary.com/dukebcqfx/image/upload/v1753600487/bahkt9l9rmbqwrvmadl8.jpg","price":"30000"}],"restaurantId":"67757705-3181-4524-9bc2-2ae994102462","paymentMethod":"cod","status":"pending","address":"jsj","notes":"sksks","phone":"0963258741","name":"am"}
I/flutter (27690): Response status: 500
I/flutter (27690): Response body: {"statusCode":500,"message":"Internal server error"}
I/flutter (27690): Error details: {statusCode: 500, message: Internal server error} 

---

_**Assistant**_

Bạn đã gửi đúng định dạng giống như các đơn hàng thành công trước đó (`title`, `quantity`, `price` đều là string), nhưng vẫn bị lỗi 500. Điều này cho thấy **có thể một trường khác hoặc giá trị nào đó không hợp lệ hoặc backend có logic kiểm tra bổ sung**.

### Các điểm cần kiểm tra tiếp:

1. **Kiểm tra trường `restaurantId`**
   - Đảm bảo `restaurantId` là ID của **restaurant**, không phải user.
   - Trong dữ liệu đơn hàng thành công, trường user có id giống với restaurantId bạn đang gửi. Nếu backend yêu cầu `restaurantId` là id của nhà hàng, hãy xác nhận lại giá trị này.

2. **Kiểm tra trường `paymentMethod`**
   - Bạn đang gửi `"cod"`, nhưng có thể backend yêu cầu `"COD"` (viết hoa) hoặc một giá trị khác.
   - Thử đổi thành `"COD"`.

3. **Kiểm tra trường `status`**
   - Bạn đang gửi `"pending"`, nhưng trong dữ liệu trả về có cả `"preparing"`. Tuy nhiên, `"pending"` vẫn hợp lệ.

4. **Kiểm tra trường `notes`**
   - Nếu không có ghi chú, thử **bỏ hẳn trường này** thay vì gửi `null`.

5. **Kiểm tra trường `name`**
   - Trường `name` bạn gửi là tên người nhận, nhưng backend có thể yêu cầu trường này là `fullName` hoặc không cần trường này (vì thông tin user đã có trong token).

---

### Đề xuất thử nghiệm gửi dữ liệu như sau:

````dart
final orderData = {
  'items': cartItems
      .map((item) => {
            'title': item['name'],
            'quantity': item['quantity'].toString(),
            'thumbnail': item['thumbnail'],
            'price': item['price'].toString(),
          })
      .toList(),
  'restaurantId': '67757705-3181-4524-9bc2-2ae994102462',
  'paymentMethod': paymentMethod.toUpperCase(), // Đổi thành 'COD'
  'status': 'pending',
  'address': _addressController.text.trim(),
  // Bỏ trường notes nếu rỗng
  if (_notesController.text.trim().isNotEmpty)
    'notes': _notesController.text.trim(),
  'phone': _phoneController.text.trim(),
  // Bỏ trường name nếu không bắt buộc
  // 'name': _nameController.text.trim(),
};
````

---

**Nếu vẫn lỗi:**
- Hỏi backend về yêu cầu chính xác các trường cần gửi.
- Kiểm tra log backend để biết lỗi chi tiết (ví dụ: thiếu trường, sai giá trị, không tìm thấy restaurantId, ...).

---

**Tóm lại:**  
- Đảm bảo `restaurantId` đúng.
- Thử đổi `paymentMethod` thành `"COD"`.
- Bỏ trường `notes` nếu rỗng.
- Bỏ trường `name` nếu không bắt buộc.

Nếu vẫn lỗi, bạn cần log chi tiết từ backend hoặc hỏi backend về định dạng request mẫu chính xác!

---

_**User**_

I/ViewRootImpl@9049e52[MainActivity](29376): mWNT: merge t to BBQ
I/flutter (29376): Sending order data: {"items":[{"title":"Đậu hủ kho","quantity":"1","thumbnail":"https://res.cloudinary.com/dukebcqfx/image/upload/v1753599727/zw3xexi1lpuwe7rdcxc0.jpg","price":"20000"}],"restaurantId":"67757705-3181-4524-9bc2-2ae994102462","paymentMethod":"COD","status":"pending","address":"sksk","notes":"ksks","phone":"0963258741"}
I/flutter (29376): Response status: 400
I/flutter (29376): Response body: {"message":["paymentMethod must be one of the following values: cod, credit_card"],"error":"Bad Request","statusCode":400}
I/flutter (29376): Error details: {message: [paymentMethod must be one of the following values: cod, credit_card], error: Bad Request, statusCode: 400}

---

_**Assistant**_

Bạn đã nhận được lỗi **400 Bad Request** với thông báo:
```
"paymentMethod must be one of the following values: cod, credit_card"
```
Điều này nghĩa là **backend chỉ chấp nhận**:
- `"cod"`
- `"credit_card"`

Nhưng bạn đang gửi `"COD"` (chữ hoa).

---

## Cách sửa

**Chỉ cần gửi paymentMethod là `"cod"` (chữ thường):**

````dart
'paymentMethod': paymentMethod.toLowerCase(), // Đúng chuẩn backend yêu cầu
````

**Hoặc sửa trực tiếp khi tạo orderData:**
```dart
'paymentMethod': 'cod', // Nếu chỉ hỗ trợ COD
```

---

## Tóm lại
- Đổi `'paymentMethod': paymentMethod.toUpperCase()`  
  **thành**  
  `'paymentMethod': paymentMethod.toLowerCase()`

Sau khi sửa, bạn sẽ gửi đúng định dạng backend yêu cầu và sẽ không còn lỗi này nữa.

---

_**User**_

cập nhật  final orderData = {
      'items': cartItems
          .map((item) => {
                'title': item['name'],
                'quantity': item['quantity'].toString(),
                'thumbnail': item['thumbnail'],
                'price': item['price'].toString(),
              })
          .toList(),
      'restaurantId': '67757705-3181-4524-9bc2-2ae994102462',
      'paymentMethod': paymentMethod.toUpperCase(), // Đổi thành 'COD'
      'status': 'pending',
      'address': _addressController.text.trim(),
      // Bỏ trường notes nếu rỗng
      if (_notesController.text.trim().isNotEmpty)
        'notes': _notesController.text.trim(),
      'phone': _phoneController.text.trim(),
      // Bỏ trường name nếu không bắt buộc
      // 'name': _nameController.text.trim(),
    };
// ...existing code...

---

_**Assistant**_

````dart
final orderData = {
  'items': cartItems
      .map((item) => {
            'title': item['name'],
            'quantity': item['quantity'].toString(),
            'thumbnail': item['thumbnail'],
            'price': item['price'].toString(),
          })
      .toList(),
  'restaurantId': '67757705-3181-4524-9bc2-2ae994102462',
  'paymentMethod': paymentMethod.toLowerCase(), // Sửa thành chữ thường 'cod' hoặc 'credit_card'
  'status': 'pending',
  'address': _addressController.text.trim(),
  if (_notesController.text.trim().isNotEmpty)
    'notes': _notesController.text.trim(),
  'phone': _phoneController.text.trim(),
  // 'name': _nameController.text.trim(), // Bỏ nếu không bắt buộc
};
// ...existing code...
````

**Lưu ý:**  
- `paymentMethod` phải là `'cod'` hoặc `'credit_card'` (chữ thường) đúng theo yêu cầu backend.  
- Các trường khác giữ nguyên như cũ.

---

_**User**_

mbda0.onFrameDraw:4
I/ViewRootImpl@9049e52[MainActivity](30456): mWNT: merge t to BBQ
I/flutter (30456): Sending order data: {"items":[{"title":"Nấm Kho Tương ","quantity":"1","thumbnail":"https://res.cloudinary.com/dukebcqfx/image/upload/v1753600487/bahkt9l9rmbqwrvmadl8.jpg","price":"30000"}],"restaurantId":"67757705-3181-4524-9bc2-2ae994102462","paymentMethod":"cod","status":"pending","address":"ska","notes":"kkaa","phone":"0963258741"}
I/flutter (30456): Response status: 500
I/flutter (30456): Response body: {"statusCode":500,"message":"Internal server error"}
I/flutter (30456): Error details: {statusCode: 500, message: Internal server error} 

---

_**Assistant**_

Bạn đã gửi đúng định dạng dữ liệu mà backend yêu cầu (`paymentMethod: "cod"`, các trường khác đều đúng), nhưng vẫn bị lỗi **500 Internal Server Error**. Điều này cho thấy lỗi nằm ở phía backend hoặc dữ liệu bạn gửi lên có giá trị không hợp lệ với logic backend.

### Các bước kiểm tra tiếp theo:

1. **Kiểm tra `restaurantId`**
   - Đảm bảo `restaurantId` là ID của nhà hàng, không phải user.
   - Nếu bạn chỉ có 1 nhà hàng, hãy xác nhận lại ID này với backend.

2. **Kiểm tra dữ liệu gửi lên**
   - Đảm bảo tất cả các trường đều không null, không rỗng (trừ `notes` có thể null).
   - Đảm bảo `items` không rỗng, mỗi item đều có đủ trường `title`, `quantity`, `thumbnail`, `price`.

3. **Kiểm tra backend**
   - Lỗi 500 thường do backend không xử lý được dữ liệu hoặc có bug.
   - Nếu bạn có quyền, hãy kiểm tra log backend để biết lỗi chi tiết.

4. **Thử gửi request với Postman/cURL**
   - Gửi đúng dữ liệu như trên bằng Postman/cURL để xác định lỗi do client hay backend.

---

### Gợi ý thử nghiệm

- Thử **bỏ trường `status`** khi gửi lên (vì backend có thể tự set mặc định).
- Thử **bỏ trường `notes`** nếu rỗng hoặc không cần thiết.
- Đảm bảo trường `phone` đúng định dạng số điện thoại.

---

### Ví dụ gửi dữ liệu tối giản:

```dart
final orderData = {
  'items': cartItems
      .map((item) => {
            'title': item['name'],
            'quantity': item['quantity'].toString(),
            'thumbnail': item['thumbnail'],
            'price': item['price'].toString(),
          })
      .toList(),
  'restaurantId': '67757705-3181-4524-9bc2-2ae994102462',
  'paymentMethod': paymentMethod.toLowerCase(),
  'address': _addressController.text.trim(),
  if (_notesController.text.trim().isNotEmpty)
    'notes': _notesController.text.trim(),
  'phone': _phoneController.text.trim(),
};
```

---

**Nếu vẫn lỗi:**  
- Bạn cần liên hệ backend để kiểm tra log chi tiết hoặc cung cấp tài liệu API mẫu để xác định chính xác trường nào gây lỗi.
- Lỗi 500 là lỗi phía server, không phải do định dạng request của bạn nữa.

---

_**User**_

không cần nhà hàng

---

_**Assistant**_

Nếu **không cần trường `restaurantId`** khi gửi đơn hàng, bạn chỉ cần **bỏ dòng `'restaurantId': ...`** khỏi `orderData`. Dưới đây là đoạn code đã cập nhật:

````dart
final orderData = {
  'items': cartItems
      .map((item) => {
            'title': item['name'],
            'quantity': item['quantity'].toString(),
            'thumbnail': item['thumbnail'],
            'price': item['price'].toString(),
          })
      .toList(),
  'paymentMethod': paymentMethod.toLowerCase(),
  'status': 'pending',
  'address': _addressController.text.trim(),
  if (_notesController.text.trim().isNotEmpty)
    'notes': _notesController.text.trim(),
  'phone': _phoneController.text.trim(),
  // 'name': _nameController.text.trim(), // Bỏ nếu không bắt buộc
};
// ...existing code...
````

**Lưu ý:**  
- Nếu backend không yêu cầu trường này, việc bỏ đi sẽ giúp tránh lỗi 500 do trường không hợp lệ.
- Nếu vẫn lỗi, hãy kiểm tra lại tài liệu API hoặc hỏi backend về các trường bắt buộc khác.

---

_**User**_

I/ViewRootImpl@9049e52[MainActivity](31460): mWNT: merge t to BBQ
I/flutter (31460): Sending order data: {"items":[{"title":"Nấm Kho Tương ","quantity":"1","thumbnail":"https://res.cloudinary.com/dukebcqfx/image/upload/v1753600487/bahkt9l9rmbqwrvmadl8.jpg","price":"30000"}],"paymentMethod":"cod","status":"pending","address":"an","notes":"aklala","phone":"0963258741"}
I/flutter (31460): Response status: 400
I/flutter (31460): Response body: {"message":["restaurantId must be a UUID"],"error":"Bad Request","statusCode":400}
I/flutter (31460): Error details: {message: [restaurantId must be a UUID], error: Bad Request, statusCode: 400}

---

_**Assistant**_

Lỗi trả về:
```
"restaurantId must be a UUID"
```
nghĩa là **backend yêu cầu trường `restaurantId`** và nó phải là một UUID hợp lệ.

### Cách khắc phục:
- **Bắt buộc phải gửi trường `restaurantId`** trong `orderData`.
- Giá trị phải là một UUID hợp lệ (ví dụ: `"67757705-3181-4524-9bc2-2ae994102462"`).

---

**Sửa lại đoạn tạo orderData như sau:**

````dart
final orderData = {
  'items': cartItems
      .map((item) => {
            'title': item['name'],
            'quantity': item['quantity'].toString(),
            'thumbnail': item['thumbnail'],
            'price': item['price'].toString(),
          })
      .toList(),
  'restaurantId': '67757705-3181-4524-9bc2-2ae994102462', // BẮT BUỘC PHẢI CÓ
  'paymentMethod': paymentMethod.toLowerCase(),
  'status': 'pending',
  'address': _addressController.text.trim(),
  if (_notesController.text.trim().isNotEmpty)
    'notes': _notesController.text.trim(),
  'phone': _phoneController.text.trim(),
  // 'name': _nameController.text.trim(), // Bỏ nếu không bắt buộc
};
````

---

**Tóm lại:**  
- Luôn gửi trường `restaurantId` với giá trị là UUID hợp lệ khi tạo đơn hàng.  
- Các trường khác giữ nguyên như hiện tại.

Sau khi sửa, backend sẽ không báo lỗi này nữa.

---

_**User**_

đã sửa nhưng chưa đặt được hàng

---

_**Assistant**_

Bạn đã sửa đúng định dạng dữ liệu gửi lên, bao gồm cả trường `restaurantId` là UUID hợp lệ. Nếu vẫn **chưa đặt được hàng** và backend trả về lỗi 500 hoặc lỗi khác, hãy kiểm tra các điểm sau:

---

### 1. **Kiểm tra lại dữ liệu gửi lên**
- Đảm bảo tất cả các trường đều đúng định dạng, không có trường nào bị null hoặc rỗng (trừ `notes` có thể rỗng).
- Đảm bảo `cartItems` không rỗng và mỗi item đều có đủ `title`, `quantity`, `thumbnail`, `price`.

### 2. **Kiểm tra giá trị của các trường**
- `paymentMethod` phải là `"cod"` hoặc `"credit_card"` (chữ thường).
- `status` là `"pending"` (đúng).
- `phone` phải là số hợp lệ.
- `restaurantId` phải là UUID hợp lệ và **phải tồn tại trên hệ thống backend** (nếu không sẽ lỗi 500).

### 3. **Kiểm tra log backend**
- Lỗi 500 là lỗi phía server, có thể do logic backend hoặc dữ liệu không hợp lệ với hệ thống.
- Nếu bạn không có quyền truy cập log backend, hãy liên hệ người quản trị backend để kiểm tra log chi tiết.

### 4. **Thử gửi request bằng Postman/cURL**
- Copy toàn bộ dữ liệu bạn gửi từ Flutter, thử gửi bằng Postman/cURL để xác định lỗi do client hay backend.

---

## Gợi ý thử nghiệm gửi dữ liệu tối giản

Hãy thử gửi dữ liệu tối giản nhất có thể (chỉ các trường bắt buộc):

````dart
final orderData = {
  'items': cartItems
      .map((item) => {
            'title': item['name'],
            'quantity': item['quantity'].toString(),
            'thumbnail': item['thumbnail'],
            'price': item['price'].toString(),
          })
      .toList(),
  'restaurantId': '67757705-3181-4524-9bc2-2ae994102462',
  'paymentMethod': paymentMethod.toLowerCase(),
  'status': 'pending',
  'address': _addressController.text.trim(),
  'phone': _phoneController.text.trim(),
  // Chỉ thêm notes nếu có
  if (_notesController.text.trim().isNotEmpty)
    'notes': _notesController.text.trim(),
};
````

---

## Nếu vẫn không đặt được hàng

- **Gửi lại log lỗi mới nhất** (status code, message, body).
- **Hỏi backend về yêu cầu chính xác các trường và giá trị hợp lệ**.
- **Kiểm tra lại restaurantId**: Đảm bảo ID này là của nhà hàng hợp lệ trên hệ thống backend.

---

**Tóm lại:**  
Bạn đã làm đúng về phía client. Nếu vẫn lỗi, vấn đề nằm ở backend hoặc dữ liệu không hợp lệ với hệ thống backend. Bạn cần log chi tiết từ backend hoặc xác nhận lại các trường bắt buộc với backend.

---

_**User**_

vẫn lỗi I/ViewRootImpl@9049e52[MainActivity]( 4451): mWNT: merge t to BBQ
I/flutter ( 4451): Sending order data: {"items":[{"title":"Nấm Kho Tương ","quantity":"1","thumbnail":"https://res.cloudinary.com/dukebcqfx/image/upload/v1753600487/bahkt9l9rmbqwrvmadl8.jpg","price":"30000"}],"restaurantId":"67757705-3181-4524-9bc2-2ae994102462","paymentMethod":"cod","status":"pending","address":"sso","phone":"096325741","notes":"ksospw"}
I/flutter ( 4451): Response status: 500
I/flutter ( 4451): Response body: {"statusCode":500,"message":"Internal server error"}
I/flutter ( 4451): Error details: {statusCode: 500, message: Internal server error} , kiểm tra nếu nhấn xác nhận đặt hàng đơn hàng sẽ được lưu vào api https://food-app-cweu.onrender.com/api/v1/Orders/

---

_**Assistant**_

Bạn đã gửi đúng định dạng dữ liệu, nhưng vẫn bị lỗi **500 Internal Server Error** khi gọi API `/api/v1/orders/`. Điều này cho thấy phía backend không xử lý được request, có thể do một số nguyên nhân sau:

---

### 1. **Kiểm tra kỹ từng trường gửi lên**
- `restaurantId`: Đảm bảo **ID này là của một nhà hàng hợp lệ** trên hệ thống backend (không phải user, không phải admin).
- `items`: Không được rỗng, mỗi item phải có đủ `title`, `quantity`, `thumbnail`, `price` (đều là string).
- `paymentMethod`: Đúng là `"cod"` hoặc `"credit_card"`.
- `status`: `"pending"` là hợp lệ.
- `address`, `phone`: Không được rỗng, đúng định dạng.
- `notes`: Có thể có hoặc không.

---

### 2. **Kiểm tra lại dữ liệu mẫu đã lưu thành công trên backend**
Bạn đã gửi đúng định dạng như các đơn hàng thành công trước đó. Tuy nhiên, có thể:
- **restaurantId bạn gửi không đúng với hệ thống backend** (ví dụ: không phải là ID của một nhà hàng thực sự).
- **User hiện tại không có quyền đặt hàng cho restaurantId này**.

---

### 3. **Kiểm tra lại API backend**
- Nếu bạn có quyền, hãy kiểm tra log backend để biết lỗi chi tiết.
- Nếu không, hãy hỏi người quản trị backend về yêu cầu chính xác của API này.

---

### 4. **Thử với sản phẩm và nhà hàng khác**
- Thử thay đổi `restaurantId` sang một ID khác (nếu có).
- Thử đặt hàng với sản phẩm khác, số lượng khác.

---

### 5. **Kiểm tra quyền của user**
- Đảm bảo token bạn dùng là của user bình thường, không phải admin hoặc nhà hàng.

---

### 6. **Thử gửi request bằng Postman/cURL**
- Copy toàn bộ dữ liệu bạn gửi từ Flutter, thử gửi bằng Postman/cURL để xác định lỗi do client hay backend.

---

## **Tóm lại**
- **Lỗi 500 là lỗi phía backend**. Bạn đã gửi đúng định dạng, nên vấn đề có thể do:
  - `restaurantId` không hợp lệ hoặc không tồn tại.
  - User không có quyền đặt hàng cho nhà hàng này.
  - Backend có bug hoặc logic kiểm tra dữ liệu bị lỗi.

**Bạn cần kiểm tra lại `restaurantId` và hỏi backend về log chi tiết hoặc yêu cầu chính xác của API này.**  
Nếu cần, hãy gửi thêm log backend hoặc tài liệu API để mình hỗ trợ sâu hơn!

---

_**User**_

tại sao đặt được hàng rồi chưa hiện sản phẩm đã thêm và giá 

---

_**Assistant**_

Nguyên nhân bạn **đặt được hàng nhưng đơn hàng không hiện sản phẩm và tổng tiền là 0đ** là do **dữ liệu gửi lên hoặc backend lưu chưa đúng danh sách món ăn**.

### Các nguyên nhân thường gặp:

1. **Gửi lên `items` rỗng hoặc sai cấu trúc**
   - Nếu `cartItems` rỗng hoặc map sai trường, backend sẽ lưu đơn hàng không có sản phẩm.

2. **Sai tên trường trong từng item**
   - Backend yêu cầu trường là `title`, `quantity`, `thumbnail`, `price` (đều là string).
   - Nếu thiếu trường hoặc sai tên, backend có thể bỏ qua.

3. **Backend không xử lý đúng dữ liệu**
   - Nếu dữ liệu đúng mà backend vẫn lưu rỗng, có thể backend có bug.

---

### Cách kiểm tra & khắc phục

**1. Kiểm tra lại dữ liệu gửi lên**
- Trước khi gửi, in ra log:
  ```dart
  debugPrint('Sending order data: ${jsonEncode(orderData)}');
  ```
- Đảm bảo `items` là một list có ít nhất 1 phần tử, mỗi phần tử có đủ trường `title`, `quantity`, `thumbnail`, `price`.

**2. Đảm bảo đúng kiểu dữ liệu**
- Tất cả các trường trong item đều là string:
  ```dart
  'title': item['name'].toString(),
  'quantity': item['quantity'].toString(),
  'thumbnail': item['thumbnail'].toString(),
  'price': item['price'].toString(),
  ```

**3. Kiểm tra lại phía backend**
- Nếu dữ liệu gửi lên đúng mà vẫn không lưu, cần kiểm tra lại API backend.

---

### Ví dụ đúng cho `orderData`:

```json
{
  "items": [
    {
      "title": "Nấm Kho Tương",
      "quantity": "1",
      "thumbnail": "https://...",
      "price": "30000"
    }
  ],
  "restaurantId": "67757705-3181-4524-9bc2-2ae994102462",
  "paymentMethod": "cod",
  "status": "pending",
  "address": "an",
  "phone": "0963258741"
}
```

---

### **Tóm lại:**
- Đảm bảo `cartItems` không rỗng khi đặt hàng.
- Đảm bảo mỗi item có đủ trường và đúng tên trường.
- Kiểm tra log gửi lên và log backend nếu vẫn lỗi.

**Nếu bạn đã kiểm tra đúng như trên mà vẫn không hiện sản phẩm, hãy gửi lại log `orderData` bạn gửi lên và phản hồi từ backend để mình hỗ trợ sâu hơn!**

---

_**User**_

kiểm tra import 'package:flutter/material.dart';
import 'home.dart'; // Giữ nguyên import
import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';

// ...existing code...

class CartPage extends StatefulWidget {
  final Map<String, dynamic>? food;
  final int? quantity;
  static final List<Map<String, dynamic>> globalCartItems = [];
  const CartPage({Key? key, this.food, this.quantity}) : super(key: key);

  @override
  State<CartPage> createState() => _CartPageState();
}

class _CartPageState extends State<CartPage> {
  final _formKey = GlobalKey<FormState>();
  final TextEditingController _addressController = TextEditingController();
  final TextEditingController _notesController = TextEditingController();
  final TextEditingController _nameController = TextEditingController();
  final TextEditingController _phoneController = TextEditingController();
  List<Map<String, dynamic>> cartItems = [];
  String paymentMethod = 'COD';

  int get totalPrice {
    int sum = 0;
    for (var item in cartItems) {
      sum += ((item['price'] ?? 0) as num).toInt() *
          ((item['quantity'] ?? 1) as int);
    }
    return sum;
  }

  @override
  void initState() {
    super.initState();
    // Nếu có món mới được truyền vào, thêm vào giỏ hàng toàn cục
    if (widget.food != null && widget.quantity != null) {
      CartPage.globalCartItems.add({
        'name': widget.food!['title'] ?? 'Không tên',
        'price': widget.food!['price'] ?? 0,
        'quantity': widget.quantity,
        'thumbnail': widget.food!['thumbnail'],
      });
    }
    cartItems = List<Map<String, dynamic>>.from(CartPage.globalCartItems);
  }

  void removeItem(int index) {
    setState(() {
      CartPage.globalCartItems.removeAt(index);
      cartItems = List<Map<String, dynamic>>.from(CartPage.globalCartItems);
    });
  }

  // Hàm xử lý đặt hàng được giữ nguyên
  Future<void> _placeOrder() async {
    if (cartItems.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Giỏ hàng trống!')),
      );
      return;
    }
    if (_formKey.currentState?.validate() != true) {
      return;
    }

    final prefs = await SharedPreferences.getInstance();
    final token = prefs.getString('token');
    if (token == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Bạn chưa đăng nhập!')),
      );
      return;
    }
    final orderData = {
      'items': cartItems
          .map((item) => {
                'title': item['name'],
                'quantity': item['quantity'].toString(),
                'thumbnail': item['thumbnail'],
                'price': item['price'].toString(),
              })
          .toList(),
      'restaurantId': '14c90cd2-4e4b-11f0-a57b-c84bd64b6215',
      'paymentMethod': paymentMethod.toLowerCase(),
      'status': 'pending',
      'address': _addressController.text.trim(),
      'phone': _phoneController.text.trim(),
      // Chỉ thêm notes nếu có
      if (_notesController.text.trim().isNotEmpty)
        'notes': _notesController.text.trim(),
    };
// ...existing code...

    debugPrint('Sending order data: ${jsonEncode(orderData)}');

    try {
      final response = await http.post(
        Uri.parse('https://food-app-cweu.onrender.com/api/v1/orders'),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $token',
        },
        body: jsonEncode(orderData),
      );

      debugPrint('Response status: ${response.statusCode}');
      debugPrint('Response body: ${response.body}');

      if (response.statusCode == 201 || response.statusCode == 200) {
        setState(() {
          CartPage.globalCartItems.clear();
          cartItems.clear();
        });
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Đặt hàng thành công!')),
        );
        Navigator.of(context).pushReplacementNamed('/donhang');
      } else {
        final error = jsonDecode(response.body);
        debugPrint('Error details: $error');
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Đặt hàng thất bại: ${error['message']}')),
        );
      }
    } catch (e) {
      debugPrint('Exception while creating order: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi kết nối: $e')),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Giỏ hàng của bạn',
            style: TextStyle(color: Colors.white)),
        backgroundColor: Colors.orange,
        iconTheme:
            const IconThemeData(color: Colors.white), // Đặt màu icon về trắng
        actions: [
          IconButton(
            icon: const Icon(Icons.shopping_cart),
            tooltip: 'Giỏ hàng',
            onPressed: () {},
          ),
        ],
      ),
      resizeToAvoidBottomInset: true,
      body: cartItems.isEmpty
          ? const Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.remove_shopping_cart,
                      size: 80, color: Colors.grey),
                  SizedBox(height: 16),
                  Text(
                    'Giỏ hàng trống!',
                    style: TextStyle(fontSize: 18, color: Colors.grey),
                  ),
                  Text(
                    'Hãy thêm món ngon vào giỏ của bạn nhé!',
                    style: TextStyle(fontSize: 14, color: Colors.grey),
                  ),
                ],
              ),
            )
          : SingleChildScrollView(
              // Changed: Wrapped with SingleChildScrollView
              child: Form(
                key: _formKey,
                child: Column(
                  children: [
                    // Changed: Integrated cart items directly into the Column
                    ...cartItems.asMap().entries.map((entry) {
                      final int index = entry.key;
                      final Map<String, dynamic> item = entry.value;
                      return Card(
                        margin: const EdgeInsets.symmetric(
                            horizontal: 16, vertical: 8),
                        elevation: 4, // Thêm đổ bóng
                        shape: RoundedRectangleBorder(
                          borderRadius:
                              BorderRadius.circular(12), // Bo góc mềm mại
                        ),
                        child: Padding(
                          padding: const EdgeInsets.all(12.0),
                          child: Row(
                            children: [
                              ClipRRect(
                                borderRadius: BorderRadius.circular(8.0),
                                child: item['thumbnail'] != null &&
                                        item['thumbnail'].isNotEmpty
                                    ? Image.network(
                                        item['thumbnail'],
                                        width: 80,
                                        height: 80,
                                        fit: BoxFit.cover,
                                        errorBuilder:
                                            (context, error, stackTrace) =>
                                                Container(
                                          width: 80,
                                          height: 80,
                                          color: Colors.orange[50],
                                          child: const Icon(Icons.fastfood,
                                              color: Colors.orange, size: 40),
                                        ),
                                      )
                                    : Container(
                                        width: 80,
                                        height: 80,
                                        color: Colors.orange[50],
                                        child: const Icon(Icons.fastfood,
                                            color: Colors.orange, size: 40),
                                      ),
                              ),
                              const SizedBox(width: 16),
                              Expanded(
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      item['name'],
                                      style: const TextStyle(
                                          fontSize: 16,
                                          fontWeight: FontWeight.bold),
                                      maxLines: 2,
                                      overflow: TextOverflow.ellipsis,
                                    ),
                                    const SizedBox(height: 4),
                                    Text(
                                      '${item['price']}đ',
                                      style: TextStyle(
                                          fontSize: 15,
                                          color: Colors.grey[700]),
                                    ),
                                    const SizedBox(height: 8),
                                    Row(
                                      mainAxisAlignment:
                                          MainAxisAlignment.spaceBetween,
                                      children: [
                                        Row(
                                          children: [
                                            _buildQuantityButton(
                                                Icons.remove_circle_outline,
                                                () {
                                              setState(() {
                                                if (item['quantity'] > 1) {
                                                  item['quantity']--;
                                                  CartPage.globalCartItems[
                                                          index]['quantity'] =
                                                      item['quantity'];
                                                }
                                              });
                                            }),
                                            Padding(
                                              padding:
                                                  const EdgeInsets.symmetric(
                                                      horizontal: 8.0),
                                              child: Text(
                                                '${item['quantity']}',
                                                style: const TextStyle(
                                                    fontSize: 16,
                                                    fontWeight:
                                                        FontWeight.bold),
                                              ),
                                            ),
                                            _buildQuantityButton(
                                                Icons.add_circle_outline, () {
                                              setState(() {
                                                item['quantity']++;
                                                CartPage.globalCartItems[index]
                                                        ['quantity'] =
                                                    item['quantity'];
                                              });
                                            }),
                                          ],
                                        ),
                                        IconButton(
                                          icon: const Icon(Icons.delete,
                                              color: Colors.red, size: 24),
                                          onPressed: () => removeItem(index),
                                          tooltip: 'Xóa món ăn',
                                        ),
                                      ],
                                    ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ),
                      );
                    }).toList(),
                    _buildOrderSummary(),
                  ],
                ),
              ),
            ),
      // bottomNavigationBar: null, // Có thể bỏ nếu không cần thiết
    );
  }

  Widget _buildQuantityButton(IconData icon, VoidCallback onPressed) {
    return Container(
      decoration: BoxDecoration(
        color: Colors.orange[100],
        borderRadius: BorderRadius.circular(20),
      ),
      child: IconButton(
        icon: Icon(icon, color: Colors.orange),
        onPressed: onPressed,
        constraints: const BoxConstraints(), // Để icon không bị giãn quá mức
        padding: EdgeInsets.zero,
      ),
    );
  }

  Widget _buildOrderSummary() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        boxShadow: [
          BoxShadow(
            color: Colors.grey.withOpacity(0.2),
            spreadRadius: 2,
            blurRadius: 5,
            offset: const Offset(0, -3), // Shadows on top
          ),
        ],
        borderRadius: const BorderRadius.only(
          topLeft: Radius.circular(20),
          topRight: Radius.circular(20),
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text(
                'Tổng cộng:',
                style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: Colors.black87),
              ),
              Text(
                '${totalPrice}đ',
                style: const TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: Colors.red),
              ),
            ],
          ),
          const Divider(height: 24, thickness: 1), // Đường kẻ phân cách
          Text(
            'Phương thức thanh toán:',
            style:
                TextStyle(fontWeight: FontWeight.bold, color: Colors.grey[700]),
          ),
          Row(
            children: [
              Expanded(
                child: RadioListTile<String>(
                  title: const Text('COD (Thanh toán khi nhận hàng)'),
                  value: 'COD',
                  groupValue: paymentMethod,
                  onChanged: (value) {
                    setState(() {
                      paymentMethod = value!;
                    });
                  },
                  activeColor: Colors.orange,
                  contentPadding: EdgeInsets.zero,
                ),
              ),
              Expanded(
                child: RadioListTile<String>(
                  title: const Text('Chuyển khoản'),
                  value: 'Bank',
                  groupValue: paymentMethod,
                  onChanged: (value) {
                    setState(() {
                      paymentMethod = value!;
                    });
                  },
                  activeColor: Colors.orange,
                  contentPadding: EdgeInsets.zero,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          _buildTextFormField(_nameController, 'Tên người nhận',
              validator: (value) => value == null || value.isEmpty
                  ? 'Vui lòng nhập tên người nhận'
                  : null),
          _buildTextFormField(_phoneController, 'Số điện thoại',
              keyboardType: TextInputType.phone,
              validator: (value) => value == null || value.isEmpty
                  ? 'Vui lòng nhập số điện thoại'
                  : null),
          _buildTextFormField(_addressController, 'Địa chỉ giao hàng',
              validator: (value) => value == null || value.isEmpty
                  ? 'Vui lòng nhập địa chỉ giao hàng'
                  : null),
          _buildTextFormField(_notesController, 'Ghi chú (tuỳ chọn)',
              maxLines: 2),
          const SizedBox(height: 16),
          SizedBox(
            width: double.infinity,
            child: ElevatedButton.icon(
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.orange,
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(vertical: 12),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(10),
                ),
                elevation: 3,
              ),
              onPressed: _placeOrder, // Gọi hàm đặt hàng
              icon: const Icon(Icons.check_circle_outline),
              label: const Text(
                'Xác nhận đặt hàng',
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildTextFormField(TextEditingController controller, String labelText,
      {TextInputType? keyboardType,
      String? Function(String?)? validator,
      int maxLines = 1}) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8.0),
      child: TextFormField(
        controller: controller,
        decoration: InputDecoration(
          labelText: labelText,
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: BorderSide(color: Colors.grey.shade400),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: const BorderSide(color: Colors.orange, width: 2),
          ),
          contentPadding:
              const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          filled: true,
          fillColor: Colors.grey[50],
        ),
        keyboardType: keyboardType,
        validator: validator,
        maxLines: maxLines,
      ),
    );
  }
}

// ---

class OrderPage extends StatefulWidget {
  final String paymentMethod;
  final List<Map<String, dynamic>>? initialOrders;
  const OrderPage({super.key, this.paymentMethod = 'COD', this.initialOrders});

  @override
  State<OrderPage> createState() => _OrderPageState();
}

class _OrderPageState extends State<OrderPage> {
  late List<Map<String, dynamic>> orders;

  final Map<String, String> statusMap = {
    'pending': 'Chờ xác nhận',
    'confirmed': 'Đã xác nhận',
    'delivering': 'Đang giao',
    'delivered': 'Đã giao',
    'cancelled': 'Đã hủy',
  };

  @override
  void initState() {
    super.initState();
    orders = widget.initialOrders ?? [];
    // Tải các đơn hàng từ API khi trang được khởi tạo
    _fetchOrders();
  }

  Future<void> _fetchOrders() async {
    final prefs = await SharedPreferences.getInstance();
    final token = prefs.getString('token');

    if (token == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Bạn chưa đăng nhập!')),
      );
      return;
    }

    try {
      final response = await http.get(
        Uri.parse('https://food-app-cweu.onrender.com/api/v1/orders/my-orders'),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $token',
        },
      );

      if (response.statusCode == 200) {
        final List<dynamic> fetchedOrders = jsonDecode(response.body)['data'];
        setState(() {
          orders = fetchedOrders
              .map((order) => order as Map<String, dynamic>)
              .toList();
        });
      } else {
        debugPrint('Failed to load orders: ${response.body}');
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Không thể tải đơn hàng.')),
        );
      }
    } catch (e) {
      debugPrint('Error fetching orders: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Lỗi kết nối khi tải đơn hàng: $e')),
      );
    }
  }

  Color _getStatusColor(String status) {
    switch (status) {
      case 'pending':
        return Colors.orange;
      case 'confirmed':
        return Colors.blue;
      case 'delivering':
        return Colors.purple;
      case 'delivered':
        return Colors.green;
      case 'cancelled':
        return Colors.red;
      default:
        return Colors.grey;
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Đơn hàng của tôi',
            style: TextStyle(color: Colors.white)),
        backgroundColor: Colors.orange,
        iconTheme: const IconThemeData(color: Colors.white),
        actions: [
          IconButton(
            icon: const Icon(Icons.shopping_cart),
            tooltip: 'Giỏ hàng',
            onPressed: () {
              Navigator.of(context).push(
                MaterialPageRoute(builder: (context) => const CartPage()),
              );
            },
          ),
        ],
      ),
      body: orders.isEmpty
          ? Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.receipt_long, size: 80, color: Colors.grey),
                  SizedBox(height: 16),
                  Text(
                    'Bạn chưa có đơn hàng nào.',
                    style: TextStyle(fontSize: 18, color: Colors.grey),
                  ),
                  SizedBox(height: 8),
                  Text(
                    'Hãy bắt đầu đặt món ngay bây giờ!',
                    style: TextStyle(fontSize: 14, color: Colors.grey),
                  ),
                  SizedBox(height: 24),
                  ElevatedButton.icon(
                    onPressed: () {
                      Navigator.of(context).popUntil((route) => route.isFirst);
                      // Chắc chắn Home.dart là route đầu tiên, hoặc điều hướng đến trang chính
                      Navigator.of(context).pushReplacement(
                        MaterialPageRoute(
                            builder: (context) =>
                                const TrangHome()), // Thay thế bằng trang chủ của bạn nếu cần
                      );
                    },
                    icon: const Icon(Icons.restaurant_menu),
                    label: const Text('Xem thực đơn'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.orange,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(
                          horizontal: 20, vertical: 12),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(10),
                      ),
                    ),
                  ),
                ],
              ),
            )
          : ListView.builder(
              padding: const EdgeInsets.symmetric(vertical: 8.0),
              itemCount: orders.length,
              itemBuilder: (context, index) {
                final order = orders[index];
                final String currentStatusDisplay =
                    statusMap[order['status']] ?? 'Không xác định';

                return Card(
                  margin:
                      const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                  elevation: 5,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(15),
                  ),
                  child: Padding(
                    padding: const EdgeInsets.all(16.0),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'Mã đơn hàng: ${order['_id'] ?? 'N/A'}', // Sử dụng _id nếu có
                          style: const TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                              color: Colors.black87),
                        ),
                        const SizedBox(height: 8),
                        Text(
                          'Tổng tiền: ${order['totalPrice'] != null ? order['totalPrice'] : order['total']}đ',
                          style: const TextStyle(
                              fontSize: 15,
                              color: Colors.red,
                              fontWeight: FontWeight.bold),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          'Phương thức thanh toán: ${order['paymentMethod'] == 'cod' ? 'COD (Thanh toán khi nhận hàng)' : 'Chuyển khoản'}',
                          style:
                              TextStyle(fontSize: 14, color: Colors.grey[700]),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          'Địa chỉ: ${order['address'] ?? 'N/A'}',
                          style:
                              TextStyle(fontSize: 14, color: Colors.grey[700]),
                        ),
                        if (order['notes'] != null && order['notes'].isNotEmpty)
                          Padding(
                            padding: const EdgeInsets.only(top: 4.0),
                            child: Text(
                              'Ghi chú: ${order['notes']}',
                              style: TextStyle(
                                  fontSize: 14, color: Colors.grey[700]),
                            ),
                          ),
                        const SizedBox(height: 8),
                        Row(
                          children: [
                            Text(
                              'Trạng thái: ',
                              style: TextStyle(
                                  fontSize: 14, color: Colors.grey[700]),
                            ),
                            Container(
                              padding: const EdgeInsets.symmetric(
                                  horizontal: 8, vertical: 4),
                              decoration: BoxDecoration(
                                color: _getStatusColor(
                                        order['status'] ?? 'unknown')
                                    .withOpacity(0.1),
                                borderRadius: BorderRadius.circular(20),
                              ),
                              child: Text(
                                currentStatusDisplay,
                                style: TextStyle(
                                  color: _getStatusColor(
                                      order['status'] ?? 'unknown'),
                                  fontWeight: FontWeight.bold,
                                  fontSize: 14,
                                ),
                              ),
                            ),
                          ],
                        ),
                        const Divider(height: 20, thickness: 1),
                        const Text(
                          'Chi tiết món ăn:',
                          style: TextStyle(
                              fontSize: 15, fontWeight: FontWeight.bold),
                        ),
                        const SizedBox(height: 8),
                        ListView.builder(
                          shrinkWrap:
                              true, // Quan trọng để ListView.builder lồng nhau
                          physics:
                              const NeverScrollableScrollPhysics(), // Vô hiệu hóa cuộn của ListView con
                          itemCount: (order['items'] as List).length,
                          itemBuilder: (context, itemIndex) {
                            final foodItem =
                                (order['items'] as List)[itemIndex];
                            return Padding(
                              padding:
                                  const EdgeInsets.symmetric(vertical: 4.0),
                              child: Row(
                                children: [
                                  ClipRRect(
                                    borderRadius: BorderRadius.circular(4.0),
                                    child: foodItem['thumbnail'] != null &&
                                            foodItem['thumbnail'].isNotEmpty
                                        ? Image.network(
                                            foodItem['thumbnail'],
                                            width: 50,
                                            height: 50,
                                            fit: BoxFit.cover,
                                            errorBuilder:
                                                (context, error, stackTrace) =>
                                                    Container(
                                              width: 50,
                                              height: 50,
                                              color: Colors.grey[200],
                                              child: const Icon(
                                                  Icons.image_not_supported,
                                                  size: 25),
                                            ),
                                          )
                                        : Container(
                                            width: 50,
                                            height: 50,
                                            color: Colors.grey[200],
                                            child: const Icon(
                                                Icons.image_not_supported,
                                                size: 25),
                                          ),
                                  ),
                                  const SizedBox(width: 12),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        Text(
                                          '${foodItem['title'] ?? 'N/A'}',
                                          style: const TextStyle(
                                              fontWeight: FontWeight.w500),
                                        ),
                                        Text(
                                          '${foodItem['quantity'] ?? 1} x ${foodItem['price'] ?? 0}đ',
                                          style: TextStyle(
                                              color: Colors.grey[600]),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                            );
                          },
                        ),
                      ],
                    ),
                  ),
                );
              },
            ),
    );
  }
}


---

_**Assistant**_

Các import của bạn hoàn toàn **đúng và hợp lệ** cho file này:

````dart
import 'package:flutter/material.dart';
import 'home.dart'; // Giữ nguyên import
import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';
````

- `flutter/material.dart`: UI Flutter.
- `home.dart`: Trang chủ (file local).
- `dart:convert`: Xử lý JSON.
- `http`: Gửi request HTTP.
- `shared_preferences`: Lưu và lấy token đăng nhập.

**Không có lỗi import**. Nếu gặp lỗi khi chạy, nguyên nhân không phải do phần import này.  
Nếu bạn cần kiểm tra import của file khác hoặc muốn tối ưu import, hãy cung cấp thêm thông tin!

---

_**User**_

đơn hàng chưa hiện tên sản phẩm và giá 

---

_**Assistant**_

Bạn **đặt hàng thành công nhưng đơn hàng không hiện tên sản phẩm và giá** là do **dữ liệu gửi lên API đã bị thiếu trường `title` trong từng item**.

### Nguyên nhân
Trong code gửi order:
```dart
'items': cartItems
    .map((item) => {
          'title': item['name'],
          'quantity': item['quantity'].toString(),
          'thumbnail': item['thumbnail'],
          'price': item['price'].toString(),
        })
    .toList(),
```
Nhưng khi bạn thêm vào giỏ hàng ở `initState`:
```dart
CartPage.globalCartItems.add({
  'name': widget.food!['title'] ?? 'Không tên',
  'price': widget.food!['price'] ?? 0,
  'quantity': widget.quantity,
  'thumbnail': widget.food!['thumbnail'],
});
```
**Nếu widget.food không có trường `title` hoặc bị null, trường `name` sẽ là "Không tên".**

### Lý do không hiện sản phẩm và giá:
- Nếu `cartItems` rỗng hoặc các item không có trường `title` đúng, backend sẽ lưu đơn hàng không có sản phẩm.
- Nếu trường `price` hoặc `quantity` bị null hoặc sai kiểu, tổng tiền sẽ là 0.

---

## Cách khắc phục

**1. Đảm bảo khi thêm vào giỏ hàng, trường `name` luôn lấy từ `food['title']` và không bị null:**
```dart
CartPage.globalCartItems.add({
  'name': widget.food!['title'] ?? 'Không tên',
  'price': widget.food!['price'] ?? 0,
  'quantity': widget.quantity ?? 1,
  'thumbnail': widget.food!['thumbnail'] ?? '',
});
```

**2. Đảm bảo khi gửi order, trường `title` lấy từ `item['name']` và không bị null:**
```dart
'items': cartItems
    .map((item) => {
          'title': item['name'] ?? 'Không tên',
          'quantity': item['quantity'].toString(),
          'thumbnail': item['thumbnail'] ?? '',
          'price': item['price'].toString(),
        })
    .toList(),
```

**3. Đảm bảo `cartItems` không rỗng khi đặt hàng.**

---

## Tóm lại
- Đảm bảo khi thêm vào giỏ hàng, trường `name` luôn đúng và không bị null.
- Khi gửi order, trường `title` phải đúng tên món ăn.
- Kiểm tra lại dữ liệu gửi lên bằng `debugPrint('Sending order data: ${jsonEncode(orderData)}');` để chắc chắn `items` có đầy đủ thông tin.

**Sau khi sửa, đơn hàng sẽ hiện đúng tên sản phẩm và giá.**

---

_**User**_

tại sao lại không hiện món đã đặt số lượng và giá kiểm tra lại cách lưu api   },
    {
      "id": "669343f8-876a-4fe0-a418-bedc5e57fc51",
      "status": "pending",
      "address": "abc nguyễn đình chiểu",
      "user": {
        "id": "67757705-3181-4524-9bc2-2ae994102462",
        "fullName": "Trần Trung Trực",
        "avatar": null,
        "phone": "0862048408",
        "status": "active",
        "email": "hs236@gmail.com",
        "gender": "male",
        "createdAt": "2025-07-01T11:26:08.000Z",
        "updatedAt": "2025-07-01T11:26:08.000Z"
      },
      "notes": "Thêm ít nước mắm",
      "items": [
        {
          "quantity": "7",
          "title": "Gà rán",
          "thumbnail": "https://cokhiviendong.com/wp-content/uploads/2019/01/kinnh-nghi%E1%BB%87m-m%E1%BB%9F-qu%C3%A1n-g%C3%A0-r%C3%A1n-7.jpg",
          "price": "100000"
        },
        {
          "quantity": "5",
          "title": "Hamburger",
          "thumbnail": "https://thitbonhat.vn/wp-content/uploads/2023/10/banh-hamburger.jpg",
          "price": "100000"
        }
      ],
      "createdAt": "2025-07-26T08:28:05.000Z",
      "updatedAt": "2025-07-26T08:28:05.000Z"
    },
    {
      "id": "b9ce77ba-e9e7-4ab5-915d-4f12fdd4d85e",
      "status": "preparing",
      "address": "abc nguyễn đình chiểu",
      "user": {
        "id": "67757705-3181-4524-9bc2-2ae994102462",
        "fullName": "Trần Trung Trực",
        "avatar": null,
        "phone": "0862048408",
        "status": "active",
        "email": "hs236@gmail.com",
        "gender": "male",
        "createdAt": "2025-07-01T11:26:08.000Z",
        "updatedAt": "2025-07-01T11:26:08.000Z"
      },
      "notes": "Thêm ít nước mắm",
      "items": [
        {
          "quantity": "7",
          "title": "Gà rán",
          "thumbnail": "https://cokhiviendong.com/wp-content/uploads/2019/01/kinnh-nghi%E1%BB%87m-m%E1%BB%9F-qu%C3%A1n-g%C3%A0-r%C3%A1n-7.jpg",
          "price": "100000"
        },
        {
          "quantity": "5",
          "title": "Hamburger",
          "thumbnail": "https://thitbonhat.vn/wp-content/uploads/2023/10/banh-hamburger.jpg",
          "price": "100000"
        }
      ],
      "createdAt": "2025-07-24T10:21:55.000Z",
      "updatedAt": "2025-07-26T03:22:52.000Z"
    },
    {
      "id": "75d28ac1-c75e-4548-a65d-d5aa3a9c0e07",
      "status": "pending",
      "address": "abc nguyễn đình chiểu",
      "user": {
        "id": "67757705-3181-4524-9bc2-2ae994102462",
        "fullName": "Trần Trung Trực",
        "avatar": null,
        "phone": "0862048408",
        "status": "active",
        "email": "hs236@gmail.com",
        "gender": "male",
        "createdAt": "2025-07-01T11:26:08.000Z",
        "updatedAt": "2025-07-01T11:26:08.000Z"
      },
      "notes": null,
      "items": [],
      "createdAt": "2025-07-24T09:34:32.000Z",
      "updatedAt": "2025-07-24T09:34:32.000Z"
    },
    {
      "id": "4ee2a939-695d-446d-9d15-95124928031b",
      "status": "pending",
      "address": "abc nguyễn đình chiểu",
      "user": {
        "id": "67757705-3181-4524-9bc2-2ae994102462",
        "fullName": "Trần Trung Trực",
        "avatar": null,
        "phone": "0862048408",
        "status": "active",
        "email": "hs236@gmail.com",
        "gender": "male",
        "createdAt": "2025-07-01T11:26:08.000Z",
        "updatedAt": "2025-07-01T11:26:08.000Z"
      },
      "notes": null,
      "items": [],
      "createdAt": "2025-07-24T09:11:54.000Z",
      "updatedAt": "2025-07-24T09:11:54.000Z"
    }
  ]
}

---

_**Assistant**_

Bạn **không thấy tên món, số lượng, giá** trong đơn hàng là do **dữ liệu gửi lên API đã đúng nhưng backend lưu `items` bị rỗng hoặc không đúng cấu trúc**.

### Nguyên nhân thường gặp

1. **Gửi lên API với `items` rỗng hoặc sai cấu trúc**
   - Nếu `cartItems` rỗng, backend sẽ lưu đơn hàng không có sản phẩm.
   - Nếu mỗi item thiếu trường `title`, `quantity`, `price`, backend có thể bỏ qua.

2. **Sai kiểu dữ liệu khi gửi lên**
   - Backend yêu cầu các trường trong `items` là string (`"quantity": "1"`, `"price": "10000"`).

3. **Sai tên trường**
   - Phải là `title`, `quantity`, `thumbnail`, `price` (đúng như mẫu bạn gửi).

---

### Kiểm tra lại code gửi order

Bạn đã đúng:
```dart
'items': cartItems
    .map((item) => {
          'title': item['name'] ?? 'Không tên',
          'quantity': item['quantity'].toString(),
          'thumbnail': item['thumbnail'] ?? '',
          'price': item['price'].toString(),
        })
    .toList(),
```

**Nhưng:**  
Khi thêm vào giỏ hàng:
```dart
CartPage.globalCartItems.add({
  'name': widget.food!['title'] ?? 'Không tên',
  'price': widget.food!['price'] ?? 0,
  'quantity': widget.quantity ?? 1,
  'thumbnail': widget.food!['thumbnail'] ?? '',
});
```
Nếu `widget.food!['title']` bị null hoặc rỗng, trường `name` sẽ là `"Không tên"`.

---

### Cách khắc phục

**1. Đảm bảo khi thêm vào giỏ hàng, trường `name` luôn đúng tên món:**
```dart
CartPage.globalCartItems.add({
  'name': widget.food?['title'] ?? widget.food?['name'] ?? 'Không tên',
  'price': widget.food?['price'] ?? 0,
  'quantity': widget.quantity ?? 1,
  'thumbnail': widget.food?['thumbnail'] ?? '',
});
```
**2. Đảm bảo khi gửi lên, `cartItems` không rỗng và mỗi item có đủ trường.**

**3. Trước khi gửi, in log kiểm tra:**
```dart
debugPrint('Sending order data: ${jsonEncode(orderData)}');
```
Kiểm tra log này xem `items` có đúng dữ liệu không.

---

### Nếu vẫn không hiện món

- **Kiểm tra lại log backend**: Có thể backend đang validate sai hoặc lưu sai trường.
- **Kiểm tra API backend**: Đảm bảo API nhận đúng trường và lưu đúng cấu trúc.

---

### Tóm lại

- Đảm bảo khi thêm vào giỏ hàng, trường `name` luôn đúng tên món.
- Đảm bảo khi gửi lên, `items` không rỗng và đúng cấu trúc.
- Kiểm tra log gửi lên và log backend.

**Sau khi sửa, đơn hàng sẽ hiện đúng tên món, số lượng và giá.**  
Nếu vẫn lỗi, hãy gửi log `orderData` thực tế bạn gửi lên để mình kiểm tra kỹ hơn!

---

_**User**_

I/IMM_LC  (11287): hideSoftInputFromWindow - mService.hideSoftInput
I/flutter (11287): Order id: f3fa25e6-6343-4b6e-b8e4-729281675245 | userId: null | user: {id: d1766e44-9bf1-4d6b-8154-7d5113a3338a, fullName: an na na, avatar: null, phone: +84933225588, status: active, email: seafoodtavern@gmail.com, gender: null, createdAt: 2025-07-27T11:49:22.000Z, updatedAt: 2025-07-27T11:49:22.000Z}
I/flutter (11287): Order id: ced00485-13a5-4520-8083-ab954bdd40c6 | userId: null | user: {id: d1766e44-9bf1-4d6b-8154-7d5113a3338a, fullName: an na na, avatar: null, phone: +84933225588, status: active, email: seafoodtavern@gmail.com, gender: null, createdAt: 2025-07-27T11:49:22.000Z, updatedAt: 2025-07-27T11:49:22.000Z}
I/flutter (11287): Order id: c78956a1-0fbb-4e75-b357-8e36ee75c379 | userId: null | user: {id: d1766e44-9bf1-4d6b-8154-7d5113a3338a, fullName: an na na, avatar: null, phone: +84933225588, status: active, email: seafoodtavern@gmail.com, gender: null, createdAt: 2025-07-27T11:49:22.000Z, updatedAt: 2025-07-27T11:49:22.000Z}

---

_**Assistant**_



---

